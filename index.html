<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offline Credentials Manager</title>
    <!-- Favicon: lock icon matching the app header; color updates with theme -->
    <link id="app-favicon" rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236366F1' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='11' width='18' height='11' rx='2' ry='2'/%3E%3Cpath d='M7 11V7a5 5 0 0 1 10 0v4'/%3E%3C/svg%3E" />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>

    <!-- Custom CSS Variables for Theme Colors -->
    <style>
        :root {
            /* Default theme colors - Indigo */
            --primary-50: rgb(238 242 255);
            --primary-100: rgb(224 231 255);
            --primary-200: rgb(199 210 254);
            --primary-300: rgb(165 180 252);
            --primary-400: rgb(129 140 248);
            --primary-500: rgb(99 102 241);
            --primary-600: rgb(79 70 229);
            --primary-700: rgb(67 56 202);
            --primary-800: rgb(55 48 163);
            --primary-900: rgb(49 46 129);
        }

        /* Dynamic color classes */
        .bg-primary-50 { background-color: var(--primary-50); }
        .bg-primary-100 { background-color: var(--primary-100); }
        .bg-primary-500 { background-color: var(--primary-500); }
        .bg-primary-600 { background-color: var(--primary-600); }
        .bg-primary-700 { background-color: var(--primary-700); }
        .text-primary-500 { color: var(--primary-500); }
        .text-primary-600 { color: var(--primary-600); }
        .text-primary-700 { color: var(--primary-700); }
        .border-primary-500 { border-color: var(--primary-500); }
        .ring-primary-500 { --tw-ring-color: var(--primary-500); }
        .focus\:ring-primary-500:focus { --tw-ring-color: var(--primary-500); }

        /* Dark mode variants */
        .dark .text-primary-300 { color: var(--primary-300); }
        .dark .bg-primary-500\/20 { background-color: rgb(from var(--primary-500) r g b / 0.2); }
    </style>

    <!-- Apply theme early to prevent flash -->
    <script>
            (function () {
                const savedTheme = localStorage.getItem('theme') || 'auto';
                const root = document.documentElement;

                if (savedTheme === 'dark') {
                    root.classList.add('dark');
                } else if (savedTheme === 'auto') {
                    if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                        root.classList.add('dark');
                    }
                }
            })();
    </script>

    <!-- Crypto.js for encryption -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Custom Styles */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .icon-btn {
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease-in-out;
        }

        .icon-btn:hover {
            background-color: rgb(229 231 235);
        }

        .dark .icon-btn:hover {
            background-color: rgb(55 65 81);
        }

        .theme-btn.active {
            background-color: var(--primary-50) !important;
        }

        .dark .theme-btn.active {
            background-color: var(--primary-500-20) !important;
        }

        /* Themed form controls */
        input[type="checkbox"],
        input[type="radio"],
        input[type="range"] {
            accent-color: var(--primary-600);
        }

        .dark input[type="checkbox"],
        .dark input[type="radio"],
        .dark input[type="range"] {
            accent-color: var(--primary-400);
        }

        /* Password Generator length slider track color */
        #generator-length-slider {
            background-color: var(--primary-100);
        }

        .dark #generator-length-slider {
            background-color: var(--primary-500-20);
        }

        .main-grid {
            grid-template-columns: 280px 1fr 2fr;
        }

        /* Password Generator 3-column layout */
        .main-grid.three-column {
            grid-template-columns: 280px 1fr 1fr;
        }

        /* Profile 2-column layout */
        .main-grid.two-column {
            grid-template-columns: 280px 1fr;
        }

        /* Responsive Design Adjustments */
        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr 1.5fr;
            }

            .main-grid.three-column {
                grid-template-columns: 1fr 1fr;
            }

            #third-panel-container {
                display: none !important;
            }

            #nav-sidebar {
                position: fixed;
                left: -280px;
                top: 0;
                height: 100%;
                z-index: 40;
                transition: left 0.3s ease-in-out;
                box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            }

            #nav-sidebar.is-open {
                left: 0;
            }
        }

        @media (max-width: 767px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            #item-list-container.mobile-hidden {
                display: none;
            }

            #details-pane-container:not(.mobile-hidden) {
                display: block;
            }

            #details-pane-container.mobile-hidden {
                display: none;
            }
        }

        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .dark ::-webkit-scrollbar-track {
            background: #2d3748;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #555;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .dark ::-webkit-scrollbar-thumb:hover {
            background: #777;
        }

        /* Hide scrollbars completely for clean look */
        .scrollbar-hidden {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        .scrollbar-hidden::-webkit-scrollbar {
            display: none;  /* Chrome, Safari, Opera */
        }

        /* Prevent scroll chaining from inner scrollers to parent/page */
        .scroll-isolated {
            overscroll-behavior: contain;
            overscroll-behavior-y: contain;
        }

        /* Hide number input spinners */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            appearance: textfield;
            -moz-appearance: textfield;
        }

        /* Flash highlight for navigation targets */
        @keyframes flashHighlight {
            0% { box-shadow: 0 0 0 3px var(--primary-500); background-color: var(--primary-50); }
            60% { box-shadow: 0 0 0 0 var(--primary-500); background-color: transparent; }
            100% { box-shadow: none; background-color: transparent; }
        }
        .flash-highlight {
            animation: flashHighlight 1.6s ease-out 1;
        }
    </style>
</head>

<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 overflow-hidden">

    <!-- App Root -->
    <div id="app" class="h-screen w-screen">

        <!-- Lock Screen / Setup Screen -->
        <div id="lock-screen"
            class="h-full w-full flex items-center justify-center bg-gray-100 dark:bg-gray-900 transition-opacity duration-500">
            <div class="w-full max-w-md p-8 space-y-6 bg-white dark:bg-gray-800 rounded-2xl shadow-xl">
                <div class="text-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="mx-auto text-primary-500">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                    </svg>
                    <h2 id="lock-screen-title" class="mt-4 text-3xl font-bold text-gray-900 dark:text-white"></h2>
                    <p id="lock-screen-subtitle" class="mt-2 text-sm text-gray-600 dark:text-gray-400"></p>
                </div>

                <form id="master-password-form" class="space-y-4">
                    <div id="user-name-container" class="relative hidden">
                        <input id="user-name" type="text"
                            class="w-full px-4 py-3 text-gray-900 bg-gray-100 dark:bg-gray-700 dark:text-white border-2 border-transparent rounded-lg focus:ring-2 focus:ring-primary-500 focus:outline-none"
                            placeholder="Your Name">
                    </div>
                    <div class="relative">
                        <input id="master-password" type="password" required
                            class="w-full px-4 py-3 text-gray-900 bg-gray-100 dark:bg-gray-700 dark:text-white border-2 border-transparent rounded-lg focus:ring-2 focus:ring-primary-500 focus:outline-none"
                            placeholder="Master Password">
                    </div>
                    <div id="confirm-password-container" class="relative hidden">
                        <input id="confirm-master-password" type="password"
                            class="w-full px-4 py-3 text-gray-900 bg-gray-100 dark:bg-gray-700 dark:text-white border-2 border-transparent rounded-lg focus:ring-2 focus:ring-primary-500 focus:outline-none"
                            placeholder="Confirm Master Password">
                    </div>

                    <p id="password-error" class="text-red-500 text-sm h-4"></p>

                    <div>
                        <button type="submit" id="unlock-button"
                            class="w-full px-4 py-3 font-semibold text-white bg-primary-600 rounded-lg hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 dark:focus:ring-offset-gray-800 transition-transform transform hover:scale-105">
                            Unlock
                        </button>
                    </div>
                    <div id="forgot-password-container" class="text-center pt-2" style="display: none;">
                        <button type="button" id="forgot-password-btn"
                            class="text-sm text-gray-500 hover:text-primary-600 dark:text-gray-400 dark:hover:text-primary-400 underline-offset-2 hover:underline">Forgot
                            password?</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Main Application -->
        <div id="main-app" class="h-full w-full hidden opacity-0 transition-opacity duration-500">
            <div class="main-grid h-full grid relative">
                <!-- Mobile Nav Toggle -->
                <button id="mobile-menu-btn"
                    class="lg:hidden absolute top-4 left-4 z-30 p-2 rounded-md bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
                <div id="mobile-overlay" class="lg:hidden fixed inset-0 bg-black/50 z-30 hidden"></div>

                <!-- Left Column: Categories & Controls -->
                <div id="nav-sidebar"
                    class="bg-white dark:bg-gray-800/50 border-r border-gray-200 dark:border-gray-700/50 flex flex-col p-4 w-[280px] lg:relative lg:left-0">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="text-primary-500">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                            </svg>
                            <h1 class="text-xl font-bold">Vault</h1>
                        </div>
                        <div class="flex items-center gap-1">
                            <button id="global-search-btn" class="icon-btn" title="Search (Ctrl+/)">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                </svg>
                            </button>
                            <button id="lock-button" class="icon-btn" title="Lock Vault">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                    <path d="M7 11V7a5 5 0 0 1 9.9-1"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <nav id="category-nav" class="flex-grow space-y-1">
                        <!-- Categories will be injected here -->
                    </nav>

                    <div class="mt-4">
                        <button id="import-export-button"
                            class="w-full flex items-center justify-center gap-2 px-3 py-2.5 text-sm font-medium rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                                <polyline points="17 8 12 3 7 8" />
                                <line x1="12" y1="3" x2="12" y2="15" />
                            </svg>
                            <span>Import / Export</span>
                        </button>
                    </div>

                    <div class="mt-auto pt-4 border-t border-gray-200 dark:border-gray-700/50">
                        <!-- Auto logout info -->
                        <div id="auto-lock-footer" 
                            class="text-xs text-gray-500 dark:text-gray-400 text-center mb-2 flex items-center justify-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                            <span id="auto-lock-footer-text">Auto-lock after 1 min of inactivity</span>
                        </div>
                        <!-- Search tip -->
                        <div
                            class="text-xs text-gray-500 dark:text-gray-400 text-center mb-3 flex items-center justify-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="11" cy="11" r="8"></circle>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            </svg>
                            Ctrl + / brings up search anywhere
                        </div>

                        <div class="flex items-center justify-center space-x-2">
                            <button id="theme-light" class="theme-btn p-2 rounded-lg" title="Light Mode">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="5"></circle>
                                    <line x1="12" y1="1" x2="12" y2="3"></line>
                                    <line x1="12" y1="21" x2="12" y2="23"></line>
                                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                                    <line x1="1" y1="12" x2="3" y2="12"></line>
                                    <line x1="21" y1="12" x2="23" y2="12"></line>
                                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                                </svg>
                            </button>
                            <button id="theme-dark" class="theme-btn p-2 rounded-lg" title="Dark Mode">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                                </svg>
                            </button>
                            <button id="theme-auto" class="theme-btn p-2 rounded-lg" title="System Default">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="3" y1="9" x2="21" y2="9"></line>
                                    <line x1="9" y1="21" x2="9" y2="9"></line>
                                </svg>
                            </button>
                        </div>
                    </div>

                </div>

                <!-- Middle Column: Item List -->
                <div id="item-list-container"
                    class="bg-gray-50 dark:bg-gray-900 flex-col p-4 overflow-y-auto scrollbar-hidden hidden md:flex">
                    <div class="flex items-center justify-between mb-4 sticky top-0 bg-gray-50 dark:bg-gray-900 py-2">
                        <h2 id="item-list-title" class="text-2xl font-bold"></h2>
                        <button id="add-new-item-btn"
                            class="flex items-center gap-2 px-3 py-2 text-sm font-semibold text-white bg-primary-600 rounded-lg hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 dark:focus:ring-offset-gray-900 transition-transform transform hover:scale-105">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"
                                stroke-linejoin="round">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            New
                        </button>
                    </div>
                    <div class="relative mb-4">
                        <input type="text" id="search-bar" placeholder="Search..."
                            class="w-full pl-10 pr-4 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-primary-500 focus:outline-none">
                        <svg class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400"
                            xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                    </div>
                    <div id="item-list" class="space-y-2">
                        <!-- Item list will be injected here -->
                    </div>
                </div>

                <!-- Right Column: Details / Form -->
                <div id="details-pane-container" class="flex-col p-6 overflow-y-auto scrollbar-hidden hidden md:flex">
                    <!-- Mobile back button -->
                    <button id="mobile-back-btn"
                        class="md:hidden flex items-center gap-2 text-sm font-medium text-gray-600 dark:text-gray-400 mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="19" y1="12" x2="5" y2="12"></line>
                            <polyline points="12 19 5 12 12 5"></polyline>
                        </svg>
                        Back
                    </button>
                    <div id="details-pane" class="flex-grow">
                        <!-- Details view / form will be injected here -->
                        <div id="details-placeholder"
                            class="h-full flex flex-col items-center justify-center text-center text-gray-500 dark:text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round"
                                stroke-linejoin="round" class="mb-4 text-gray-400 dark:text-gray-500">
                                <path
                                    d="M20 12c0-2.2-1.8-4-4-4H8c-2.2 0-4 1.8-4 4v4c0 2.2 1.8 4 4 4h8c2.2 0 4-1.8 4-4v-4z" />
                                <path d="M16 12H8" />
                            </svg>
                            <h3 class="text-xl font-semibold">Select an item</h3>
                            <p class="mt-1">Or create a new one to get started.</p>
                        </div>
                    </div>
                </div>

                <!-- Third Column: Additional Content -->
                <div id="third-panel-container" class="flex-col p-6 overflow-y-auto scrollbar-hidden hidden lg:flex">
                    <div id="third-panel" class="flex-grow">
                        <!-- Third column content will be injected here -->
                    </div>
                </div>

            </div>
        </div>

    </div>

    <!-- Modals -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
        <!-- Forgot Password Modal -->
        <div id="forgot-password-modal"
            class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-md p-6 hidden">
            <h3 class="text-2xl font-bold text-gray-800 dark:text-white flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="text-yellow-500">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z">
                    </path>
                    <line x1="12" y1="9" x2="12" y2="13"></line>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
                Password Recovery
            </h3>
            <p class="mt-4 text-gray-600 dark:text-gray-400">There is no way to recover your master password. However,
                you can save a backup of your encrypted data before wiping the vault to start over.</p>
            <div class="mt-6 space-y-3">
                <button id="export-from-forgot-btn"
                    class="w-full flex items-center justify-center gap-2 px-4 py-3 font-semibold text-white bg-primary-600 rounded-lg hover:bg-primary-700 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                        <polyline points="7 10 12 15 17 10" />
                        <line x1="12" y1="15" x2="12" y2="3" />
                    </svg>
                    Export Encrypted Backup
                </button>
                <button id="proceed-to-wipe-btn"
                    class="w-full px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700">Wipe Data & Start
                    Over</button>
            </div>
            <div class="mt-6 flex justify-end">
                <button id="cancel-forgot-modal"
                    class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500">Cancel</button>
            </div>
        </div>

        <!-- Panic Modal -->
        <div id="panic-modal" class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-md p-6 hidden">
            <h3 class="text-2xl font-bold text-red-500 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z">
                    </path>
                    <line x1="12" y1="9" x2="12" y2="13"></line>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
                Panic Wipe Confirmation
            </h3>
            <p class="mt-4 text-gray-600 dark:text-gray-400">Are you absolutely sure? This action cannot be undone. All
                your stored data will be permanently deleted from this device.</p>
            <p class="mt-2 text-gray-600 dark:text-gray-400">To confirm, type <strong
                    class="text-red-500 user-select-none">DELETE</strong> below.</p>
            <input id="panic-confirm-input" type="text"
                class="mt-4 w-full px-3 py-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-red-500 focus:outline-none"
                placeholder="DELETE">
            <div class="mt-6 flex justify-end gap-3">
                <button id="cancel-panic"
                    class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500">Cancel</button>
                <button id="confirm-panic"
                    class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 disabled:bg-red-400 disabled:cursor-not-allowed"
                    disabled>Wipe Data</button>
            </div>
        </div>

        <!-- Import/Export Modal -->
        <div id="import-export-modal"
            class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-md p-6 hidden">
            <h3 class="text-2xl font-bold">Import / Export Data</h3>
            <p class="mt-2 text-gray-600 dark:text-gray-400">Export your encrypted data to a file for backup, or import
                a previously saved file.</p>

            <div class="mt-6 space-y-4">
                <button id="export-data-btn"
                    class="w-full flex items-center justify-center gap-2 px-4 py-3 font-semibold text-white bg-primary-600 rounded-lg hover:bg-primary-700 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                        <polyline points="7 10 12 15 17 10" />
                        <line x1="12" y1="15" x2="12" y2="3" />
                    </svg>
                    Export Encrypted Vault
                </button>

                <!-- Import Warning -->
                <div
                    class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-3">
                    <div class="flex items-start gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="text-yellow-600 dark:text-yellow-400 mt-0.5 flex-shrink-0">
                            <path
                                d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z">
                            </path>
                            <line x1="12" y1="9" x2="12" y2="13"></line>
                            <line x1="12" y1="17" x2="12.01" y2="17"></line>
                        </svg>
                        <div class="text-sm">
                            <p class="font-medium text-yellow-800 dark:text-yellow-200">Import Warning</p>
                            <p class="text-yellow-700 dark:text-yellow-300">Importing will completely replace all your
                                existing credentials. Consider exporting a backup first.</p>
                        </div>
                    </div>
                </div>

                <div
                    class="relative border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-6 text-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="mx-auto text-gray-400 mb-2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                        <polyline points="17 8 12 3 7 8" />
                        <line x1="12" y1="3" x2="12" y2="15" />
                    </svg>
                    <p>Drag & drop a vault file here or click to select</p>
                    <input type="file" id="import-file-input"
                        class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept=".json">
                </div>
                <p id="import-status" class="text-sm h-4 text-center"></p>
            </div>

            <div class="mt-6 flex justify-end">
                <button id="close-import-export-modal"
                    class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500">Close</button>
            </div>
        </div>

        <!-- Import Verification Modal -->
        <div id="import-verification-modal"
            class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-md p-6 hidden">
            <div class="flex items-center gap-3 mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="text-primary-500">
                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                    <polyline points="22,6 12,13 2,6"></polyline>
                </svg>
                <h3 class="text-2xl font-bold">Verify Import Identity</h3>
            </div>
            
            <p class="text-gray-600 dark:text-gray-400 mb-6">To import this vault backup, please verify your identity by providing the email and security answer used during export.</p>
            
            <form id="import-verification-form" class="space-y-4">
                <div>
                    <label for="verify-email" class="block text-sm font-medium mb-2">Email Address</label>
                    <input type="email" id="verify-email" required
                        class="w-full px-3 py-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:outline-none"
                        placeholder="Enter your email address">
                </div>
                
                <div>
                    <label for="verify-security-answer" class="block text-sm font-medium mb-2">Security Question</label>
                    <p id="security-question-display" class="text-sm text-gray-600 dark:text-gray-400 mb-2 p-2 bg-gray-50 dark:bg-gray-700 rounded italic"></p>
                    <input type="text" id="verify-security-answer" required
                        class="w-full px-3 py-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:outline-none"
                        placeholder="Enter your answer">
                </div>
                
                <p id="verification-error" class="text-red-500 text-sm h-4"></p>
                
                <div class="flex gap-3 pt-4">
                    <button type="button" id="cancel-verification-btn"
                        class="flex-1 px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500">
                        Cancel
                    </button>
                    <button type="submit" id="verify-and-import-btn"
                        class="flex-1 px-4 py-2 rounded-lg bg-primary-600 text-white hover:bg-primary-700">
                        Verify & Import
                    </button>
                </div>
            </form>
        </div>

        <!-- Delete Confirmation Modal -->
        <div id="delete-confirm-modal"
            class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-md p-6 hidden">
            <div class="flex items-center gap-3 mb-4">
                <div
                    class="flex-shrink-0 w-10 h-10 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="text-red-600 dark:text-red-400">
                        <polyline points="3,6 5,6 21,6"></polyline>
                        <path d="m19,6v14a2,2 0 0,1-2,2H7a2,2 0 0,1-2-2V6m3,0V4a2,2 0 0,1,2-2h4a2,2 0 0,1,2,2v2"></path>
                        <line x1="10" y1="11" x2="10" y2="17"></line>
                        <line x1="14" y1="11" x2="14" y2="17"></line>
                    </svg>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Delete Entry</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400">This action cannot be undone</p>
                </div>
            </div>

            <p class="text-gray-600 dark:text-gray-400 mb-6">
                Are you sure you want to delete "<span id="delete-item-name"
                    class="font-medium text-gray-900 dark:text-white"></span>"? This entry will be permanently removed
                from your vault.
            </p>

            <div class="flex gap-3">
                <button id="cancel-delete-btn"
                    class="flex-1 px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300 font-medium hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors">
                    Cancel
                </button>
                <button id="confirm-delete-btn"
                    class="flex-1 px-4 py-2 rounded-lg bg-red-600 text-white font-medium hover:bg-red-700 transition-colors">
                    Delete
                </button>
            </div>
        </div>
    </div>

    <!-- Global Search Modal (separate lightweight backdrop to avoid coupling with other modals) -->
    <div id="global-search-backdrop" class="fixed inset-0 bg-black/40 hidden items-start justify-center z-[60] pt-24">
        <div id="global-search-modal" class="w-full max-w-2xl mx-4 bg-white dark:bg-gray-800 rounded-xl shadow-2xl overflow-hidden">
            <div class="p-3 border-b border-gray-200 dark:border-gray-700 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
                <input id="global-search-input" type="text" placeholder="Search across all entries..." class="flex-1 bg-transparent outline-none text-sm py-2" autocomplete="off">
                <div class="text-xs text-gray-400 hidden sm:block">Ctrl+/</div>
            </div>
            <div id="global-search-results" class="max-h-80 overflow-y-auto">
                <!-- results -->
            </div>
            <div class="p-2 text-xs text-gray-500 dark:text-gray-400 border-t border-gray-200 dark:border-gray-700 flex items-center justify-between">
                <div>Arrow keys to navigate • Enter to open • Esc to close</div>
                <button id="global-search-close" class="px-2 py-1 rounded hover:bg-gray-100 dark:hover:bg-gray-700">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Main Application Logic
        document.addEventListener('DOMContentLoaded', () => {

            // --- COLOR THEME MANAGEMENT ---
            const colorThemes = {
                indigo: {
                    name: 'Indigo',
                    colors: {
                        50: 'rgb(238 242 255)',
                        100: 'rgb(224 231 255)',
                        200: 'rgb(199 210 254)',
                        300: 'rgb(165 180 252)',
                        400: 'rgb(129 140 248)',
                        500: 'rgb(99 102 241)',
                        600: 'rgb(79 70 229)',
                        700: 'rgb(67 56 202)',
                        800: 'rgb(55 48 163)',
                        900: 'rgb(49 46 129)'
                    }
                },
                blue: {
                    name: 'Blue',
                    colors: {
                        50: 'rgb(239 246 255)',
                        100: 'rgb(219 234 254)',
                        200: 'rgb(191 219 254)',
                        300: 'rgb(147 197 253)',
                        400: 'rgb(96 165 250)',
                        500: 'rgb(59 130 246)',
                        600: 'rgb(37 99 235)',
                        700: 'rgb(29 78 216)',
                        800: 'rgb(30 64 175)',
                        900: 'rgb(30 58 138)'
                    }
                },
                emerald: {
                    name: 'Emerald',
                    colors: {
                        50: 'rgb(236 253 245)',
                        100: 'rgb(209 250 229)',
                        200: 'rgb(167 243 208)',
                        300: 'rgb(110 231 183)',
                        400: 'rgb(52 211 153)',
                        500: 'rgb(16 185 129)',
                        600: 'rgb(5 150 105)',
                        700: 'rgb(4 120 87)',
                        800: 'rgb(6 95 70)',
                        900: 'rgb(6 78 59)'
                    }
                },
                purple: {
                    name: 'Purple',
                    colors: {
                        50: 'rgb(250 245 255)',
                        100: 'rgb(243 232 255)',
                        200: 'rgb(233 213 255)',
                        300: 'rgb(216 180 254)',
                        400: 'rgb(196 181 253)',
                        500: 'rgb(168 85 247)',
                        600: 'rgb(147 51 234)',
                        700: 'rgb(126 34 206)',
                        800: 'rgb(107 33 168)',
                        900: 'rgb(88 28 135)'
                    }
                },
                rose: {
                    name: 'Rose',
                    colors: {
                        50: 'rgb(255 241 242)',
                        100: 'rgb(255 228 230)',
                        200: 'rgb(254 205 211)',
                        300: 'rgb(253 164 175)',
                        400: 'rgb(251 113 133)',
                        500: 'rgb(244 63 94)',
                        600: 'rgb(225 29 72)',
                        700: 'rgb(190 18 60)',
                        800: 'rgb(159 18 57)',
                        900: 'rgb(136 19 55)'
                    }
                },
                amber: {
                    name: 'Amber',
                    colors: {
                        50: 'rgb(255 251 235)',
                        100: 'rgb(254 243 199)',
                        200: 'rgb(253 230 138)',
                        300: 'rgb(252 211 77)',
                        400: 'rgb(251 191 36)',
                        500: 'rgb(245 158 11)',
                        600: 'rgb(217 119 6)',
                        700: 'rgb(180 83 9)',
                        800: 'rgb(146 64 14)',
                        900: 'rgb(120 53 15)'
                    }
                },
                teal: {
                    name: 'Teal',
                    colors: {
                        50: 'rgb(240 253 250)',
                        100: 'rgb(204 251 241)',
                        200: 'rgb(153 246 228)',
                        300: 'rgb(94 234 212)',
                        400: 'rgb(45 212 191)',
                        500: 'rgb(20 184 166)',
                        600: 'rgb(13 148 136)',
                        700: 'rgb(15 118 110)',
                        800: 'rgb(17 94 89)',
                        900: 'rgb(19 78 74)'
                    }
                },
                orange: {
                    name: 'Orange',
                    colors: {
                        50: 'rgb(255 247 237)',
                        100: 'rgb(255 237 213)',
                        200: 'rgb(254 215 170)',
                        300: 'rgb(253 186 116)',
                        400: 'rgb(251 146 60)',
                        500: 'rgb(249 115 22)',
                        600: 'rgb(234 88 12)',
                        700: 'rgb(194 65 12)',
                        800: 'rgb(154 52 18)',
                        900: 'rgb(124 45 18)'
                    }
                }
            };

            const applyColorTheme = (themeName) => {
                const theme = colorThemes[themeName];
                if (!theme) return;

                const root = document.documentElement;
                Object.entries(theme.colors).forEach(([shade, color]) => {
                    root.style.setProperty(`--primary-${shade}`, color);
                });

                // Save theme choice
                localStorage.setItem('userThemeColor', themeName);
                localStorage.removeItem('userCustomColor'); // Clear custom color when using preset
                // Update favicon to match theme
                updateFaviconColor(getComputedStyle(document.documentElement).getPropertyValue('--primary-600'));
            };

            // Function to convert hex to RGB
            const hexToRgb = (hex) => {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? {
                    r: parseInt(result[1], 16),
                    g: parseInt(result[2], 16),
                    b: parseInt(result[3], 16)
                } : null;
            };

            // Function to convert RGB to HSL
            const rgbToHsl = (r, g, b) => {
                r /= 255; g /= 255; b /= 255;
                const max = Math.max(r, g, b), min = Math.min(r, g, b);
                let h, s, l = (max + min) / 2;

                if (max === min) {
                    h = s = 0;
                } else {
                    const d = max - min;
                    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                    switch (max) {
                        case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                        case g: h = (b - r) / d + 2; break;
                        case b: h = (r - g) / d + 4; break;
                    }
                    h /= 6;
                }
                return { h: h * 360, s: s * 100, l: l * 100 };
            };

            // Function to convert HSL to RGB
            const hslToRgb = (h, s, l) => {
                h /= 360; s /= 100; l /= 100;
                const hue2rgb = (p, q, t) => {
                    if (t < 0) t += 1;
                    if (t > 1) t -= 1;
                    if (t < 1/6) return p + (q - p) * 6 * t;
                    if (t < 1/2) return q;
                    if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                    return p;
                };

                let r, g, b;
                if (s === 0) {
                    r = g = b = l;
                } else {
                    const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                    const p = 2 * l - q;
                    r = hue2rgb(p, q, h + 1/3);
                    g = hue2rgb(p, q, h);
                    b = hue2rgb(p, q, h - 1/3);
                }
                return { r: Math.round(r * 255), g: Math.round(g * 255), b: Math.round(b * 255) };
            };

            // Function to generate color palette from a base color
            const generateColorPalette = (baseColor) => {
                const rgb = hexToRgb(baseColor);
                if (!rgb) return null;

                const hsl = rgbToHsl(rgb.r, rgb.g, rgb.b);
                const palette = {};

                // Generate different shades and tints
                const shades = [
                    { shade: 50, l: Math.min(95, hsl.l + 40), s: Math.max(10, hsl.s - 30) },
                    { shade: 100, l: Math.min(90, hsl.l + 30), s: Math.max(20, hsl.s - 20) },
                    { shade: 200, l: Math.min(85, hsl.l + 20), s: Math.max(30, hsl.s - 10) },
                    { shade: 300, l: Math.min(75, hsl.l + 10), s: hsl.s },
                    { shade: 400, l: Math.min(65, hsl.l + 5), s: Math.min(100, hsl.s + 5) },
                    { shade: 500, l: hsl.l, s: hsl.s }, // Base color
                    { shade: 600, l: Math.max(35, hsl.l - 10), s: Math.min(100, hsl.s + 10) },
                    { shade: 700, l: Math.max(25, hsl.l - 20), s: Math.min(100, hsl.s + 15) },
                    { shade: 800, l: Math.max(15, hsl.l - 30), s: Math.min(100, hsl.s + 20) },
                    { shade: 900, l: Math.max(10, hsl.l - 40), s: Math.min(100, hsl.s + 25) }
                ];

                shades.forEach(({ shade, l, s }) => {
                    const color = hslToRgb(hsl.h, s, l);
                    palette[shade] = `rgb(${color.r} ${color.g} ${color.b})`;
                });

                return palette;
            };

            // Function to apply custom color theme
            const applyCustomColorTheme = (hexColor) => {
                const palette = generateColorPalette(hexColor);
                if (!palette) return false;

                const root = document.documentElement;
                Object.entries(palette).forEach(([shade, color]) => {
                    root.style.setProperty(`--primary-${shade}`, color);
                });

                // Also set the transparency variants
                const rgb = hexToRgb(hexColor);
                if (rgb) {
                    root.style.setProperty('--primary-500-20', `rgba(${rgb.r} ${rgb.g} ${rgb.b} / 0.2)`);
                }

                // Save custom color choice
                localStorage.setItem('userCustomColor', hexColor);
                localStorage.removeItem('userThemeColor'); // Clear preset theme when using custom
                // Update favicon to match custom theme
                updateFaviconColor(getComputedStyle(document.documentElement).getPropertyValue('--primary-600'));
                return true;
            };

            // Function to get current theme color for the color picker
            const getCurrentThemeColor = () => {
                const customColor = localStorage.getItem('userCustomColor');
                if (customColor) return customColor;
                
                const themeName = localStorage.getItem('userThemeColor') || 'indigo';
                const theme = colorThemes[themeName];
                if (theme) {
                    // Convert RGB string to hex
                    const rgbMatch = theme.colors[500].match(/rgb\((\d+) (\d+) (\d+)\)/);
                    if (rgbMatch) {
                        const r = parseInt(rgbMatch[1]);
                        const g = parseInt(rgbMatch[2]);
                        const b = parseInt(rgbMatch[3]);
                        return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
                    }
                }
                return '#6366f1'; // Default indigo
            };

            const getColorThemeOptions = (currentTheme) => {
                const hasCustomColor = localStorage.getItem('userCustomColor');
                return Object.entries(colorThemes).map(([key, theme]) => {
                    const isSelected = !hasCustomColor && key === currentTheme;
                    return `
                        <div class="color-theme-option ${isSelected ? 'selected' : ''}" data-theme="${key}">
                            <div class="w-full h-12 rounded-lg border-2 ${isSelected ? 'border-gray-800 dark:border-white' : 'border-gray-200 dark:border-gray-600'} cursor-pointer flex items-center justify-center relative overflow-hidden">
                                <div class="w-full h-full flex">
                                    <div class="flex-1" style="background-color: ${theme.colors[500]}"></div>
                                    <div class="flex-1" style="background-color: ${theme.colors[600]}"></div>
                                    <div class="flex-1" style="background-color: ${theme.colors[700]}"></div>
                                </div>
                                ${isSelected ? '<div class="absolute inset-0 flex items-center justify-center"><svg class="w-6 h-6 text-white drop-shadow-lg" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg></div>' : ''}
                            </div>
                            <p class="text-xs text-center mt-1 font-medium">${theme.name}</p>
                        </div>
                    `;
                }).join('');
            };

            const setupColorThemeListeners = () => {
                document.querySelectorAll('.color-theme-option').forEach(option => {
                    option.addEventListener('click', () => {
                        const themeName = option.dataset.theme;
                        applyColorTheme(themeName);
                        
                        // Update selection visually
                        document.querySelectorAll('.color-theme-option').forEach(opt => opt.classList.remove('selected'));
                        option.classList.add('selected');
                        
                        // Update the UI immediately
                        renderProfileSettings();
                        showToast(`Theme changed to ${colorThemes[themeName].name}!`);
                    });
                });

                // Setup custom color picker listener
                const colorPicker = document.getElementById('custom-color-picker');
                const applyButton = document.getElementById('apply-custom-color');
                
                if (colorPicker && applyButton) {
                    applyButton.addEventListener('click', () => {
                        const customColor = colorPicker.value;
                        if (applyCustomColorTheme(customColor)) {
                            // Clear preset selections
                            document.querySelectorAll('.color-theme-option').forEach(opt => opt.classList.remove('selected'));
                            
                            // Update UI
                            renderProfileSettings();
                            showToast(`Custom color theme applied!`);
                        } else {
                            showToast('Failed to apply custom color. Please try again.', 'error');
                        }
                    });

                    // Apply on Enter key
                    colorPicker.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            applyButton.click();
                        }
                    });
                }
            };

            // Initialize theme on app load
            const initializeTheme = () => {
                const customColor = localStorage.getItem('userCustomColor');
                if (customColor) {
                    applyCustomColorTheme(customColor);
                } else {
                    const savedTheme = localStorage.getItem('userThemeColor') || 'indigo';
                    applyColorTheme(savedTheme);
                }
                // Ensure favicon color is synced on load
                updateFaviconColor(getComputedStyle(document.documentElement).getPropertyValue('--primary-600'));
            };

            // Update favicon color helper
            const updateFaviconColor = (cssColor) => {
                const favicon = document.getElementById('app-favicon');
                if (!favicon) return;
                // Normalize CSS color to hex if possible; fallback to provided
                let color = (cssColor || '').trim();
                if (color.startsWith('rgb')) {
                    const m = color.match(/rgb\((\d+)\s*(?:,| )\s*(\d+)\s*(?:,| )\s*(\d+)\)/i);
                    if (m) {
                        const r = Number(m[1]).toString(16).padStart(2, '0');
                        const g = Number(m[2]).toString(16).padStart(2, '0');
                        const b = Number(m[3]).toString(16).padStart(2, '0');
                        color = `#${r}${g}${b}`;
                    }
                }
                const encoded = encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='${color || '#6366F1'}' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><rect x='3' y='11' width='18' height='11' rx='2' ry='2'/><path d='M7 11V7a5 5 0 0 1 10 0v4'/></svg>`);
                favicon.href = `data:image/svg+xml,${encoded}`;
            };

            // Call theme initialization
            initializeTheme();

            // --- STATE MANAGEMENT ---
            const state = {
                isLocked: true,
                hasVault: false,
                masterPassword: null,
                decryptedData: null,
                currentCategory: 'websites',
                selectedItemId: null,
                searchTerm: '',
                activePasswordInput: null,
                autoLogoutMinutes: 1,
            };

            const categories = {
                websites: { name: 'Website Logins', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="4"></circle><line x1="1.05" y1="12" x2="7" y2="12"></line><line x1="17.01" y1="12" x2="22.96" y2="12"></line></svg>' },
                banks: { name: 'Bank Credentials', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>' },
                keys: { name: 'Software Keys', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>' },
                ids: { name: 'Government IDs', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>' },
                passwordGenerator: { name: 'Password Generator', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"></polygon></svg>' },
                profile: { name: 'Profile & Security', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>' }
            };

            const popularBanks = ["State Bank of India", "HDFC Bank", "ICICI Bank", "Axis Bank", "Kotak Mahindra Bank", "Punjab National Bank", "Bank of Baroda", "Canara Bank", "Union Bank of India", "IDBI Bank", "American Express", "Citibank", "HSBC", "Standard Chartered"];

            // --- DOM ELEMENTS ---
            const lockScreen = document.getElementById('lock-screen');
            const mainApp = document.getElementById('main-app');
            const masterPasswordForm = document.getElementById('master-password-form');
            const masterPasswordInput = document.getElementById('master-password');
            const confirmPasswordContainer = document.getElementById('confirm-password-container');
            const confirmMasterPasswordInput = document.getElementById('confirm-master-password');
            const passwordError = document.getElementById('password-error');
            const lockScreenTitle = document.getElementById('lock-screen-title');
            const lockScreenSubtitle = document.getElementById('lock-screen-subtitle');
            const unlockButton = document.getElementById('unlock-button');
            const categoryNav = document.getElementById('category-nav');
            const itemListTitle = document.getElementById('item-list-title');
            const itemList = document.getElementById('item-list');
            const addNewItemBtn = document.getElementById('add-new-item-btn');
            const detailsPane = document.getElementById('details-pane');
            const detailsPlaceholder = document.getElementById('details-placeholder');
            const searchBar = document.getElementById('search-bar');
            const lockButton = document.getElementById('lock-button');
            const userNameContainer = document.getElementById('user-name-container');
            // Global search elements
            const globalSearchBtn = document.getElementById('global-search-btn');
            const globalSearchBackdrop = document.getElementById('global-search-backdrop');
            const globalSearchModal = document.getElementById('global-search-modal');
            const globalSearchInput = document.getElementById('global-search-input');
            const globalSearchResults = document.getElementById('global-search-results');
            const globalSearchClose = document.getElementById('global-search-close');

            // Responsive elements
            const navSidebar = document.getElementById('nav-sidebar');
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            const mobileOverlay = document.getElementById('mobile-overlay');
            const mobileBackBtn = document.getElementById('mobile-back-btn');
            const itemListContainer = document.getElementById('item-list-container');
            const detailsPaneContainer = document.getElementById('details-pane-container');
            const thirdPanelContainer = document.getElementById('third-panel-container');
            const thirdPanel = document.getElementById('third-panel');

            // Modals
            const modalBackdrop = document.getElementById('modal-backdrop');
            const forgotPasswordModal = document.getElementById('forgot-password-modal');
            const panicModal = document.getElementById('panic-modal');
            const importExportModal = document.getElementById('import-export-modal');
            const importVerificationModal = document.getElementById('import-verification-modal');
            const deleteConfirmModal = document.getElementById('delete-confirm-modal');
            const deleteItemName = document.getElementById('delete-item-name');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            const cancelDeleteBtn = document.getElementById('cancel-delete-btn');

            // --- CARD TYPE DETECTION ---
            const detectCardType = (cardNumber) => {
                // Remove all non-digit characters
                const cleanNumber = cardNumber.replace(/\D/g, '');

                // Card type patterns based on industry standards
                const patterns = {
                    'Visa': /^4[0-9]{0,15}$/,
                    'Mastercard': /^5[1-5][0-9]{0,14}$|^2(?:2(?:2[1-9]|[3-9][0-9])|[3-6][0-9][0-9]|7(?:[01][0-9]|20))[0-9]{0,12}$/,
                    'American Express': /^3[47][0-9]{0,13}$/,
                    'Discover': /^6(?:011|5[0-9]{2})[0-9]{0,12}$/,
                    'Diners Club': /^3[0689][0-9]{0,11}$/,
                    'JCB': /^(?:2131|1800|35[0-9]{3})[0-9]{0,11}$/,
                    'UnionPay': /^62[0-9]{0,14}$/,
                    'RuPay': /^6(?:0[0-9]{0,14}|5[0-9]{0,14})$/
                };

                for (const [type, pattern] of Object.entries(patterns)) {
                    if (pattern.test(cleanNumber)) {
                        return type;
                    }
                }

                return cleanNumber.length > 0 ? 'Unknown' : '';
            };

            // --- ENCRYPTION HELPERS ---
            const encrypt = (data, password) => {
                const salt = CryptoJS.lib.WordArray.random(128 / 8);
                const iv = CryptoJS.lib.WordArray.random(128 / 8);
                const key = CryptoJS.PBKDF2(password, salt, { keySize: 256 / 32, iterations: 100000 });

                const encrypted = CryptoJS.AES.encrypt(JSON.stringify(data), key, { iv: iv });
                // Ensure ciphertext is in Hex format for consistent encoding
                const ciphertext = encrypted.ciphertext.toString(CryptoJS.enc.Hex);

                // The data to be authenticated includes the salt, iv, and the ciphertext itself, all in Hex.
                const authenticatedData = salt.toString(CryptoJS.enc.Hex) + iv.toString(CryptoJS.enc.Hex) + ciphertext;

                // Create HMAC (Hash-based Message Authentication Code) to ensure data integrity.
                const hmac = CryptoJS.HmacSHA256(authenticatedData, key);

                // Prepend the HMAC to the authenticated data.
                return hmac.toString(CryptoJS.enc.Hex) + authenticatedData;
            };

            const decrypt = (encryptedString, password) => {
                try {
                    // Validate input
                    if (!encryptedString || encryptedString.length < 128) {
                        console.error("Invalid encrypted string format");
                        return null;
                    }

                    const hmac = encryptedString.substring(0, 64);
                    const salt = CryptoJS.enc.Hex.parse(encryptedString.substring(64, 96));
                    const iv = CryptoJS.enc.Hex.parse(encryptedString.substring(96, 128));
                    const encryptedHex = encryptedString.substring(128);

                    const key = CryptoJS.PBKDF2(password, salt, { keySize: 256 / 32, iterations: 100000 });

                    // Recreate the data that was authenticated.
                    const authenticatedData = salt.toString(CryptoJS.enc.Hex) + iv.toString(CryptoJS.enc.Hex) + encryptedHex;

                    // Recalculate the HMAC of the received data.
                    const calculatedHmac = CryptoJS.HmacSHA256(authenticatedData, key).toString(CryptoJS.enc.Hex);

                    // Compare the received HMAC with the calculated one.
                    // If they don't match, the data has been tampered with.
                    if (hmac !== calculatedHmac) {
                        console.error("HMAC check failed: Data integrity compromised.");
                        return null;
                    }

                    // Decrypt using the ciphertext as a Hex-parsed WordArray
                    const decrypted = CryptoJS.AES.decrypt({ ciphertext: CryptoJS.enc.Hex.parse(encryptedHex) }, key, { iv: iv });
                    const decryptedString = decrypted.toString(CryptoJS.enc.Utf8);

                    if (!decryptedString) {
                        console.error("Decryption resulted in empty string");
                        return null;
                    }

                    return JSON.parse(decryptedString);
                } catch (e) {
                    console.error("Decryption failed:", e);
                    return null;
                }
            };

            // --- DATA PERSISTENCE ---
            const saveData = () => {
                if (!state.decryptedData || !state.masterPassword) return;
                const encrypted = encrypt(state.decryptedData, state.masterPassword);
                localStorage.setItem('vaultData', encrypted);
            };

            // --- UI RENDERING ---
            const render = () => {
                if (state.isLocked) {
                    lockScreen.style.display = 'flex';
                    mainApp.style.display = 'none';
                    mainApp.classList.add('opacity-0');
                    setTimeout(() => lockScreen.classList.remove('opacity-0'), 10);
                    setupLockScreen();
                } else {
                    lockScreen.style.display = 'none';
                    lockScreen.classList.add('opacity-0');
                    mainApp.style.display = 'block';
                    setTimeout(() => mainApp.classList.remove('opacity-0'), 10);
                    renderCategories();
                    renderItemList();
                    renderDetailsPane();
                    updateAutoLockFooter();
                    updateResponsiveLayout();
                }
            };

            const updateAutoLockFooter = () => {
                const footerText = document.getElementById('auto-lock-footer-text');
                if (!footerText) return;
                const m = state.autoLogoutMinutes ?? 1;
                const label = m === 0 ? 'Auto-Lock disabled' : `Auto-lock after ${m} min${m === 1 ? '' : 's'} of inactivity`;
                footerText.textContent = label;
            };

            const setupLockScreen = () => {
                const hasVaultData = localStorage.getItem('vaultData') !== null;
                const forgotPasswordContainer = document.getElementById('forgot-password-container');
                const userNameInput = document.getElementById('user-name');

                state.hasVault = hasVaultData;
                masterPasswordInput.value = '';
                confirmMasterPasswordInput.value = '';
                passwordError.textContent = '';

                if (hasVaultData) {
                    lockScreenTitle.textContent = 'Welcome Back';
                    lockScreenSubtitle.textContent = 'Enter your master password to unlock your vault.';
                    confirmPasswordContainer.style.display = 'none';
                    userNameContainer.style.display = 'none';
                    unlockButton.textContent = 'Unlock';
                    forgotPasswordContainer.style.display = 'block';

                    // Remove required attribute when hidden
                    if (userNameInput) {
                        userNameInput.removeAttribute('required');
                    }
                } else {
                    lockScreenTitle.textContent = 'Vault Guard';
                    lockScreenSubtitle.textContent = 'Set a strong master password. This password cannot be recovered.';
                    confirmPasswordContainer.style.display = 'block';
                    userNameContainer.style.display = 'block';
                    unlockButton.textContent = 'Create Vault';
                    forgotPasswordContainer.style.display = 'none';

                    // Add required attribute when visible
                    if (userNameInput) {
                        userNameInput.setAttribute('required', '');
                    }
                }
            };

            const renderCategories = () => {
                categoryNav.innerHTML = '';
                Object.keys(categories).forEach(key => {
                    const isActive = key === state.currentCategory;
                    const category = categories[key];
                    const button = document.createElement('button');
                    button.className = `w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-colors ${isActive ? 'bg-primary-100 dark:bg-primary-500/20 text-primary-700 dark:text-primary-300' : 'hover:bg-gray-100 dark:hover:bg-gray-700/50'}`;
                    button.innerHTML = `
                        ${category.icon}
                        <span>${category.name}</span>
                    `;
                    button.onclick = () => {
                        state.currentCategory = key;
                        state.selectedItemId = null;
                        state.searchTerm = '';
                        searchBar.value = '';
                        render();
                    };
                    categoryNav.appendChild(button);
                });
            };

            const renderItemList = () => {
                if (!state.decryptedData) return; // FIX: Guard against null data on resize

                const thirdPanelContainer = document.getElementById('third-panel-container');
                const mainGrid = document.querySelector('.main-grid');

                if (state.currentCategory === 'passwordGenerator') {
                    // Use full 3-column layout for password generator
                    if (mainGrid) {
                        mainGrid.classList.add('three-column');
                    }
                    // Don't hide elements here - let renderPasswordGenerator handle it
                    return;
                } else if (state.currentCategory === 'profile') {
                    // Hide item list and third panel for profile section
                    itemListContainer.style.display = 'none';
                    detailsPaneContainer.style.display = 'flex';
                    if (thirdPanelContainer) {
                        // Hide and clear third panel content when viewing profile
                        thirdPanelContainer.style.display = 'none';
                        const thirdPanel = document.getElementById('third-panel');
                        if (thirdPanel) thirdPanel.innerHTML = '';
                    }
                    if (mainGrid) {
                        mainGrid.classList.remove('three-column');
                        mainGrid.classList.add('two-column');
                    }
                    return;
                } else {
                    // Restore normal layout and ensure elements are visible, hide third panel
                    const itemListParent = document.getElementById('item-list')?.parentElement;
                    const addNewItemBtn = document.getElementById('add-new-item-btn');
                    const searchBar = document.getElementById('search-bar');

                    if (itemListParent) itemListParent.style.display = '';
                    if (addNewItemBtn) addNewItemBtn.style.display = '';
                    if (searchBar?.parentElement) searchBar.parentElement.style.display = '';
                    if (thirdPanelContainer) {
                        thirdPanelContainer.style.display = 'none';
                    }
                    if (mainGrid) {
                        mainGrid.classList.remove('three-column');
                        mainGrid.classList.remove('two-column');
                    }
                }

                const catMeta = categories[state.currentCategory] || { name: '', icon: '' };
                itemListTitle.innerHTML = `
                    <span class="inline-flex items-center gap-2">
                        <span class="text-primary-500">${catMeta.icon || ''}</span>
                        <span>${catMeta.name || ''}</span>
                    </span>
                `;
                const items = state.decryptedData[state.currentCategory] || [];

                const filteredItems = items.filter(item => {
                    const title = item.title || item.bankName || item.productName || item.idType;
                    return title.toLowerCase().includes(state.searchTerm.toLowerCase());
                });

                if (filteredItems.length === 0) {
                    itemList.innerHTML = `<div class="text-center text-gray-500 mt-8">No items found.</div>`;
                    return;
                }

                itemList.innerHTML = filteredItems.map(item => {
                    const isActive = item.id === state.selectedItemId;
                    const title = item.title || item.bankName || item.productName || item.idType;
                    let subtitle = item.username || item.nameOnAccount || item.idNumber || 'Software Key';

                    if (state.currentCategory === 'banks') {
                        const lastFour = item.cardNumber ? '•••• ' + item.cardNumber.replace(/\s/g, '').slice(-4) : '••••';
                        
                        // Priority: saved cardBrand > saved cardType > detected brand (if not Unknown) > fallback
                        let cardDisplay = '';
                        if (item.cardBrand) {
                            cardDisplay = item.cardBrand;
                        } else if (item.cardType) {
                            cardDisplay = item.cardType;
                        } else {
                            const detectedBrand = detectCardType(item.cardNumber || '');
                            cardDisplay = (detectedBrand && detectedBrand !== 'Unknown') ? detectedBrand : 'Card';
                        }
                        
                        subtitle = `${lastFour} - ${cardDisplay}`;
                    }

                    let iconHtml = '';
                    const getDomain = (url) => {
                        try {
                            if (!url || (!url.startsWith('http://') && !url.startsWith('https://'))) {
                                url = 'https://' + url;
                            }
                            return new URL(url).hostname;
                        } catch (e) {
                            return null;
                        }
                    };

                    const getBankDomainFromName = (bankName) => {
                        if (!bankName) return null;
                        
                        const name = bankName.toLowerCase().trim();
                        
                        // Comprehensive bank domain mapping
                        const bankDomains = {
                            // US Banks
                            'chase': 'chase.com',
                            'jpmorgan chase': 'chase.com',
                            'jp morgan chase': 'chase.com',
                            'bank of america': 'bankofamerica.com',
                            'wells fargo': 'wellsfargo.com',
                            'citibank': 'citibank.com',
                            'citi': 'citibank.com',
                            'goldman sachs': 'goldmansachs.com',
                            'morgan stanley': 'morganstanley.com',
                            'capital one': 'capitalone.com',
                            'us bank': 'usbank.com',
                            'pnc bank': 'pnc.com',
                            'truist': 'truist.com',
                            'td bank': 'td.com',
                            'regions bank': 'regions.com',
                            'fifth third bank': 'fiftthird.com',
                            'ally bank': 'ally.com',
                            'american express': 'americanexpress.com',
                            'discover': 'discover.com',
                            'navy federal': 'navyfederal.org',
                            'usaa': 'usaa.com',
                            'charles schwab': 'schwab.com',
                            'fidelity': 'fidelity.com',
                            
                            // UK Banks
                            'lloyds': 'lloydsbank.com',
                            'lloyds bank': 'lloydsbank.com',
                            'barclays': 'barclays.co.uk',
                            'hsbc': 'hsbc.co.uk',
                            'natwest': 'natwest.com',
                            'royal bank of scotland': 'rbs.co.uk',
                            'rbs': 'rbs.co.uk',
                            'santander': 'santander.co.uk',
                            'nationwide': 'nationwide.co.uk',
                            'halifax': 'halifax.co.uk',
                            'tesco bank': 'tescobank.com',
                            'metro bank': 'metrobankonline.co.uk',
                            'first direct': 'firstdirect.com',
                            
                            // Canadian Banks
                            'royal bank of canada': 'rbc.com',
                            'rbc': 'rbc.com',
                            'toronto dominion': 'td.com',
                            'bank of nova scotia': 'scotiabank.com',
                            'scotiabank': 'scotiabank.com',
                            'bank of montreal': 'bmo.com',
                            'bmo': 'bmo.com',
                            'canadian imperial bank': 'cibc.com',
                            'cibc': 'cibc.com',
                            
                            // European Banks
                            'deutsche bank': 'deutsche-bank.de',
                            'commerzbank': 'commerzbank.de',
                            'bnp paribas': 'bnpparibas.com',
                            'credit agricole': 'credit-agricole.fr',
                            'societe generale': 'societegenerale.com',
                            'ing': 'ing.com',
                            'abn amro': 'abnamro.com',
                            'rabobank': 'rabobank.com',
                            'unicredit': 'unicredit.it',
                            'intesa sanpaolo': 'intesasanpaolo.com',
                            
                            // Indian Banks
                            'state bank of india': 'sbi.co.in',
                            'sbi': 'sbi.co.in',
                            'hdfc bank': 'hdfcbank.com',
                            'hdfc': 'hdfcbank.com',
                            'icici bank': 'icicibank.com',
                            'icici': 'icicibank.com',
                            'axis bank': 'axisbank.com',
                            'axis': 'axisbank.com',
                            'kotak mahindra': 'kotak.com',
                            'kotak': 'kotak.com',
                            'punjab national bank': 'pnbindia.in',
                            'pnb': 'pnbindia.in',
                            'bank of baroda': 'bankofbaroda.in',
                            'canara bank': 'canarabank.com',
                            'union bank': 'unionbankofindia.co.in',
                            'yes bank': 'yesbank.in',
                            'indusind bank': 'indusind.com',
                            
                            // Australian Banks
                            'commonwealth bank': 'commbank.com.au',
                            'cba': 'commbank.com.au',
                            'westpac': 'westpac.com.au',
                            'anz': 'anz.com.au',
                            'national australia bank': 'nab.com.au',
                            'nab': 'nab.com.au',
                            
                            // Other Global Banks
                            'standard chartered': 'standardchartered.com',
                            'credit suisse': 'credit-suisse.com',
                            'ubs': 'ubs.com',
                            'jpmorgan': 'jpmorgan.com',
                            'bank of china': 'boc.cn',
                            'industrial and commercial bank': 'icbc.com.cn',
                            'icbc': 'icbc.com.cn'
                        };
                        
                        // Try exact match first
                        if (bankDomains[name]) {
                            return bankDomains[name];
                        }
                        
                        // Try partial matching for better coverage
                        for (const [bankKey, domain] of Object.entries(bankDomains)) {
                            if (name.includes(bankKey) || bankKey.includes(name.split(' ')[0])) {
                                return domain;
                            }
                        }
                        
                        // Fallback: try constructing domain from name
                        const cleanName = name.replace(/\s*(bank|banking|financial|credit union|cu)\s*/gi, '').replace(/\s+/g, '');
                        if (cleanName.length > 2) {
                            return cleanName + '.com';
                        }
                        
                        return null;
                    };

                    if (state.currentCategory === 'websites') {
                        const domain = getDomain(item.url);
                        const genericWebsiteIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9V3m-9 9h18" /></svg>`;
                        const fallbackSvg = `data:image/svg+xml;utf8,${encodeURIComponent(genericWebsiteIcon)}`;
                        if (domain) {
                            iconHtml = `<img src="https://www.google.com/s2/favicons?sz=32&domain_url=${domain}" onerror="this.onerror=null;this.src='${fallbackSvg}'" class="w-8 h-8 mr-4 rounded-md object-contain flex-shrink-0">`;
                        } else {
                            iconHtml = `<div class="w-8 h-8 mr-4 flex-shrink-0 flex items-center justify-center bg-gray-200 dark:bg-gray-700 rounded-md">${genericWebsiteIcon}</div>`;
                        }
                    } else if (state.currentCategory === 'banks') {
                        const domain = getBankDomainFromNameEnhanced(item.bankName);
                        const genericBankIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>`;
                        const fallbackSvg = `data:image/svg+xml;utf8,${encodeURIComponent(genericBankIcon)}`;
                        
                        if (domain) {
                            // Try multiple favicon services for better coverage
                            const primaryFavicon = `https://www.google.com/s2/favicons?sz=32&domain_url=${domain}`;
                            const secondaryFavicon = `https://icon.horse/icon/${domain}`;
                            
                            iconHtml = `<img src="${primaryFavicon}" 
                                onerror="this.onerror=function(){this.onerror=null;this.src='${fallbackSvg}';};this.src='${secondaryFavicon}';" 
                                class="w-8 h-8 mr-4 rounded-md object-contain flex-shrink-0 bg-white p-0.5">`;
                        } else {
                            iconHtml = `<div class="w-8 h-8 mr-4 flex-shrink-0 flex items-center justify-center bg-gray-200 dark:bg-gray-700 rounded-md">${genericBankIcon}</div>`;
                        }
                    }


                    return `
                        <div data-id="${item.id}" class="item-card cursor-pointer p-3 flex items-center rounded-lg border-2 ${isActive ? 'bg-white dark:bg-gray-700/50 border-primary-500' : 'bg-white dark:bg-gray-800 border-transparent hover:border-gray-300 dark:hover:border-gray-600'}">
                            ${iconHtml}
                            <div class="min-w-0">
                                <h4 class="font-semibold text-gray-800 dark:text-gray-100 truncate">${escapeHTML(title)}</h4>
                                <p class="text-sm text-gray-500 dark:text-gray-400 truncate">${escapeHTML(subtitle)}</p>
                            </div>
                        </div>
                    `;
                }).join('');
            };

            const renderDetailsPane = () => {
                const thirdPanelContainer = document.getElementById('third-panel-container');
                const mainGrid = document.querySelector('.main-grid');
                
                if (state.currentCategory === 'passwordGenerator') {
                    if (mainGrid) {
                        mainGrid.classList.remove('two-column');
                        mainGrid.classList.add('three-column');
                    }
                    renderPasswordGenerator();
                } else if (state.currentCategory === 'profile') {
                    // Ensure third panel is hidden and cleared for profile
                    if (thirdPanelContainer) {
                        thirdPanelContainer.style.display = 'none';
                        const thirdPanel = document.getElementById('third-panel');
                        if (thirdPanel) thirdPanel.innerHTML = '';
                    }
                    if (mainGrid) {
                        mainGrid.classList.remove('three-column');
                        mainGrid.classList.add('two-column');
                    }
                    renderProfileSettings();
                } else if (state.selectedItemId === 'new') {
                    // Hide third panel for normal forms
                    if (thirdPanelContainer) {
                        thirdPanelContainer.style.display = 'none';
                    }
                    detailsPlaceholder.style.display = 'none';
                    renderForm();
                } else {
                    const item = (state.decryptedData[state.currentCategory] || []).find(i => i.id === state.selectedItemId);
                    if (item) {
                        // Hide third panel for item details
                        if (thirdPanelContainer) {
                            thirdPanelContainer.style.display = 'none';
                        }
                        detailsPlaceholder.style.display = 'none';
                        renderItemDetails(item);
                    } else {
                        // Hide third panel for placeholder
                        if (thirdPanelContainer) {
                            thirdPanelContainer.style.display = 'none';
                        }
                        detailsPane.innerHTML = '';
                        detailsPane.appendChild(detailsPlaceholder);
                        detailsPlaceholder.style.display = 'flex';
                    }
                }
                updateResponsiveLayout();
            };

            const renderPasswordGenerator = () => {
                // Hide the item list and show both details pane and third panel
                itemListContainer.style.display = 'none';
                detailsPaneContainer.style.display = 'flex';
                const thirdPanelContainer = document.getElementById('third-panel-container');
                const thirdPanel = document.getElementById('third-panel');
                if (thirdPanelContainer) {
                    thirdPanelContainer.style.display = 'flex';
                }

                detailsPane.innerHTML = `
                    <div class="space-y-6">
                        <div class="flex items-center gap-3 mb-6">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-primary-500"><polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"></polygon></svg>
                            <h2 class="text-2xl font-bold">Password Generator</h2>
                        </div>
                        
                        <div class="relative">
                            <input type="text" id="generator-output" readonly class="w-full pr-12 pl-4 py-3 bg-gray-100 dark:bg-gray-700 rounded-lg font-mono text-lg">
                            <button id="copy-generated-password-btn" class="absolute right-2 top-1/2 -translate-y-1/2 icon-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                            </button>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label for="generator-length-slider" class="flex justify-between text-sm font-medium"><span>Length</span><span id="generator-length-value">16</span></label>
                                <input id="generator-length-slider" type="range" min="8" max="64" value="16" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700">
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                <label class="flex items-center p-3 rounded-lg bg-gray-100 dark:bg-gray-800"><input type="checkbox" id="generator-opt-uppercase" checked class="h-4 w-4 rounded text-primary-600 focus:ring-primary-500"> <span class="ml-3">Uppercase (A-Z)</span></label>
                                <label class="flex items-center p-3 rounded-lg bg-gray-100 dark:bg-gray-800"><input type="checkbox" id="generator-opt-lowercase" checked class="h-4 w-4 rounded text-primary-600 focus:ring-primary-500"> <span class="ml-3">Lowercase (a-z)</span></label>
                                <label class="flex items-center p-3 rounded-lg bg-gray-100 dark:bg-gray-800"><input type="checkbox" id="generator-opt-numbers" checked class="h-4 w-4 rounded text-primary-600 focus:ring-primary-500"> <span class="ml-3">Numbers (0-9)</span></label>
                                <label class="flex items-center p-3 rounded-lg bg-gray-100 dark:bg-gray-800"><input type="checkbox" id="generator-opt-symbols" checked class="h-4 w-4 rounded text-primary-600 focus:ring-primary-500"> <span class="ml-3">Symbols (!@#$%^&*)</span></label>
                            </div>
                        </div>
                        
                        <button id="regenerate-password-btn" class="w-full flex items-center justify-center gap-2 px-4 py-3 font-semibold text-white bg-primary-600 rounded-lg hover:bg-primary-700">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L20.49 2a9 9 0 0 1-14.85 3.36L3.51 9z"></path><path d="M20.49 15a9 9 0 0 1-14.85 3.36L3.51 22a9 9 0 0 1 14.85-3.36l2.13-3.64z"></path></svg>
                            Regenerate
                        </button>
                    </div>
                `;

                

                // Set up the Password Analysis in the third column
                if (thirdPanel) {
                    thirdPanel.innerHTML = `
                        <div class="space-y-6">
                            <!-- Password Analysis -->
                            <div class="space-y-4">
                                <div class="flex items-center gap-3 mb-4">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-500">
                                        <polyline points="20 6 9 17 4 12"></polyline>
                                    </svg>
                                    <h3 class="text-lg font-bold">Password Analysis</h3>
                                </div>
                                
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm font-medium">Strength:</span>
                                        <span id="strength-text" class="text-sm font-semibold">Strong</span>
                                    </div>
                                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                        <div id="strength-bar" class="bg-green-500 h-2 rounded-full transition-all duration-300" style="width: 80%"></div>
                                    </div>
                                    <div id="strength-details" class="text-xs text-gray-600 dark:text-gray-400">
                                        <div class="space-y-1">
                                            <div>✓ Contains uppercase letters</div>
                                            <div>✓ Contains lowercase letters</div>
                                            <div>✓ Contains numbers</div>
                                            <div>✓ Contains symbols</div>
                                            <div>✓ Good length (16+ characters)</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Quick Actions -->
                            <div class="space-y-3 border-t border-gray-200 dark:border-gray-700 pt-6">
                                <h4 class="font-semibold">Quick Actions</h4>
                                <div class="grid grid-cols-1 gap-2">
                                    <button id="generate-passphrase-btn" class="px-3 py-2 text-sm bg-gray-100 dark:bg-gray-800 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700">Generate Passphrase</button>
                                    <button id="generate-pin-btn" class="px-3 py-2 text-sm bg-gray-100 dark:bg-gray-800 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700">Generate PIN</button>
                                </div>
                            </div>

                            <!-- Password History -->
                            <div class="space-y-3 border-t border-gray-200 dark:border-gray-700 pt-6">
                                <h4 class="font-semibold">Recent Passwords</h4>
                                <div id="password-history" class="space-y-2 max-h-40 overflow-y-auto scrollbar-hidden">
                                    <!-- Password history will be populated here -->
                                </div>
                                <button id="clear-history-btn" class="text-xs text-gray-500 hover:text-red-600 dark:text-gray-400 dark:hover:text-red-400">Clear History</button>
                            </div>
                        </div>
                    `;
                }

                setupPasswordGeneratorListeners();
                updatePasswordStrength();
                loadPasswordHistory();
                generateAndDisplayPassword();
            };

            const renderProfileSettings = () => {
                // Hide the item list and only show the details pane for profile
                itemListContainer.style.display = 'none';
                detailsPaneContainer.style.display = 'flex';

                const user = state.decryptedData.user || {};
                const showFirstLoginBanner = user && user.profilePromptShown !== true;
                const currentTheme = localStorage.getItem('userThemeColor') || 'indigo';
                
                detailsPane.innerHTML = `
                    <div class="space-y-6">
                        <div class="flex items-center gap-3 mb-6">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-primary-500">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                            <h2 class="text-2xl font-bold">Profile & Security Settings</h2>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <form id="profile-form" class="md:col-span-2 lg:col-span-2 space-y-6">
                                ${showFirstLoginBanner ? `
                                <div class="p-4 rounded-lg border border-primary-200 bg-primary-50 dark:bg-primary-500/20 dark:border-primary-800 text-primary-800 dark:text-primary-200">
                                    <div class="flex items-start gap-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mt-0.5 flex-shrink-0">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <line x1="12" y1="16" x2="12" y2="12"></line>
                                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                                        </svg>
                                        <p class="text-sm font-medium">Please complete ur profile.</p>
                                    </div>
                                </div>` : ''}
                                <!-- User Information -->
                                <div class="space-y-4 p-6 bg-gray-50 dark:bg-gray-800 rounded-lg">
                                    <h3 class="text-lg font-semibold">User Information</h3>
                                    <div>
                                        <label for="profile-name" class="block text-sm font-medium mb-2">Full Name *</label>
                                        <input type="text" id="profile-name" required value="${escapeHTML(user.name || '')}"
                                            class="w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:outline-none">
                                    </div>
                                    <div>
                                        <label for="profile-email" class="block text-sm font-medium mb-2">Email Address *</label>
                                        <input type="email" id="profile-email" required value="${escapeHTML(user.email || '')}"
                                            class="w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:outline-none"
                                            placeholder="your-email@example.com">
                                    </div>
                                </div>

                                <!-- Theme Customization -->
                                <div class="space-y-4 p-6 bg-gray-50 dark:bg-gray-800 rounded-lg">
                                    <h3 class="text-lg font-semibold">Theme Customization</h3>
                                    <div>
                                        <label class="block text-sm font-medium mb-3">Primary Color Theme</label>
                                        <div class="flex items-center justify-between gap-4 mb-4 w-full">
                                            <div class="flex items-center gap-2">
                                                <input type="color" id="custom-color-picker" value="${getCurrentThemeColor()}" 
                                                    class="w-12 h-12 border-2 border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer">
                                                <div class="flex flex-col">
                                                    <span class="text-sm font-medium">Custom Color</span>
                                                    <span class="text-xs text-gray-500 dark:text-gray-400">Pick any color</span>
                                                </div>
                                            </div>
                                            <button type="button" id="apply-custom-color" 
                                                class="px-4 py-2 bg-primary-600 text-white text-sm font-semibold rounded-lg hover:bg-primary-700 transition-colors">
                                                Apply Theme
                                            </button>
                                        </div>
                                        <div class="border-t border-gray-200 dark:border-gray-600 pt-4">
                                            <label class="block text-sm font-medium mb-3">Or choose a preset</label>
                                            <div class="grid grid-cols-4 sm:grid-cols-6 gap-3">
                                                ${getColorThemeOptions(currentTheme)}
                                            </div>
                                        </div>
                                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">Choose your preferred color scheme for the entire application</p>
                                    </div>
                                </div>

                                <!-- Security Settings -->
                                <div class="space-y-4 p-6 bg-gray-50 dark:bg-gray-800 rounded-lg">
                                    <h3 class="text-lg font-semibold">Security Settings</h3>
                                    <div>
                                        <label for="security-question" class="block text-sm font-medium mb-2">Security Question *</label>
                                        <select id="security-question" required class="w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:outline-none">
                                            <option value="">-- Select a security question --</option>
                                            <option value="What was the name of your first pet?" ${user.securityQuestion === 'What was the name of your first pet?' ? 'selected' : ''}>What was the name of your first pet?</option>
                                            <option value="What city were you born in?" ${user.securityQuestion === 'What city were you born in?' ? 'selected' : ''}>What city were you born in?</option>
                                            <option value="What was your childhood nickname?" ${user.securityQuestion === 'What was your childhood nickname?' ? 'selected' : ''}>What was your childhood nickname?</option>
                                            <option value="What is your mother's maiden name?" ${user.securityQuestion === 'What is your mother\'s maiden name?' ? 'selected' : ''}>What is your mother's maiden name?</option>
                                            <option value="What was the make of your first car?" ${user.securityQuestion === 'What was the make of your first car?' ? 'selected' : ''}>What was the make of your first car?</option>
                                            <option value="What elementary school did you attend?" ${user.securityQuestion === 'What elementary school did you attend?' ? 'selected' : ''}>What elementary school did you attend?</option>
                                            <option value="What is the name of your favorite book?" ${user.securityQuestion === 'What is the name of your favorite book?' ? 'selected' : ''}>What is the name of your favorite book?</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="security-answer" class="block text-sm font-medium mb-2">Security Answer *</label>
                                        <input type="text" id="security-answer" required value="${escapeHTML(user.securityAnswer || '')}"
                                            class="w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:outline-none"
                                            placeholder="Enter your answer (case-sensitive)">
                                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">This will be required for importing vault backups</p>
                                    </div>
                                </div>

                                <!-- Auto Logout Settings -->
                                <div class="space-y-4 p-6 bg-gray-50 dark:bg-gray-800 rounded-lg">
                                    <h3 class="text-lg font-semibold">Automation Settings</h3>
                                    <div>
                                        <div class="flex flex-wrap items-center gap-2 w-full">
                                            <span class="text-sm font-medium mr-1">Auto Logout after</span>
                                            <button type="button" class="auto-logout-preset px-2.5 py-1.5 text-xs rounded border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700" data-min="1">1 min</button>
                                            <button type="button" class="auto-logout-preset px-2.5 py-1.5 text-xs rounded border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700" data-min="5">5 min</button>
                                            <button type="button" class="auto-logout-preset px-2.5 py-1.5 text-xs rounded border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700" data-min="10">10 min</button>
                                            <button type="button" class="auto-logout-preset px-2.5 py-1.5 text-xs rounded border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700" data-min="30">30 min</button>
                                            <button type="button" class="auto-logout-preset px-2.5 py-1.5 text-xs rounded border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700" data-min="0">Disabled</button>
                                            <div class="flex items-center gap-1 ml-2">
                                                <input type="number" id="auto-logout-custom" min="0" class="w-28 px-2 py-1 text-sm bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded focus:ring-2 focus:ring-primary-500 focus:outline-none" placeholder="Custom">
                                                <span class="text-xs text-gray-500">min</span>
                                            </div>
                                        </div>
                                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">You can't set both a preset and a custom value.</p>
                                    </div>
                                </div>

                                <div class="flex gap-4 pt-4">
                                    <button type="submit" id="save-profile-btn" 
                                        class="flex-1 px-4 py-2 rounded-lg bg-primary-600 text-white font-semibold hover:bg-primary-700">
                                        Save Profile
                                    </button>
                                </div>
                            </form>

                            <aside class="md:col-span-1 lg:col-span-1 h-full">
                                <div class="p-6 bg-primary-50 dark:bg-primary-500/20 border border-primary-200 dark:border-primary-800 rounded-lg h-full flex flex-col overflow-hidden min-h-0">
                                    <!-- Header -->
                                    <div class="flex items-start gap-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                            class="text-primary-600 dark:text-primary-400 mt-0.5 flex-shrink-0">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <line x1="12" y1="16" x2="12" y2="12"></line>
                                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                                        </svg>
                                        <p class="text-sm font-bold text-primary-600 dark:text-primary-400">Known Issues</p>
                                    </div>

                                    <!-- Scrollable Feature List (scrollbar hidden) -->
                                    <div id="upcoming-features-list" class="mt-3 flex-1 min-h-0 overflow-y-auto scrollbar-hidden scroll-isolated pr-1">
                                        <ul class="space-y-2 text-sm text-primary-700 dark:text-primary-300">
                                            <li>Cancel Button doesn't work on deletion</li>
                                            <li>Auto Timer setting width mismatch</li>
                                            <li>Website URL and validations fix</li>
                                            <li>Deletion of browser data while on unlock screen should redirect to creation screen</li>
                                            <li>Check if data was deleted while session is active, after every refresh, if yes, restore the data and import automatically</li>
                                        </ul>
                                    </div>

                                    <!-- Important Notice pinned at bottom -->
                                    <div class="mt-4 pt-3 border-t border-primary-200 dark:border-primary-800 flex items-start gap-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                            class="text-primary-600 dark:text-primary-400 mt-0.5 flex-shrink-0">
                                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                                            <line x1="12" y1="9" x2="12" y2="13"></line>
                                            <line x1="12" y1="17" x2="12.01" y2="17"></line>
                                        </svg>
                                        <p class="text-sm text-primary-600 dark:text-primary-300">Your email and security question will be required to import vault backups, preventing unauthorized access even if someone gets your backup file.</p>
                                    </div>
                                </div>
                            </aside>
                        </div>
                    </div>
                `;

                // If we showed the first-login banner now, mark it as shown so it won't appear again
                if (showFirstLoginBanner) {
                    try {
                        if (!state.decryptedData.user) state.decryptedData.user = {};
                        state.decryptedData.user.profilePromptShown = true;
                        saveData();
                    } catch (_) {}
                }

                // Add color theme change listeners
                setupColorThemeListeners();

                // Add form submission listener
                const profileForm = document.getElementById('profile-form');
                if (profileForm) {
                    profileForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        
                        const name = document.getElementById('profile-name').value.trim();
                        const email = document.getElementById('profile-email').value.trim();
                        const securityQuestion = document.getElementById('security-question').value;
                        const securityAnswer = document.getElementById('security-answer').value.trim();
                        
                        if (!name || !email || !securityQuestion || !securityAnswer) {
                            alert('Please fill in all required fields.');
                            return;
                        }
                        
                        // Validate email format
                        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                        if (!emailRegex.test(email)) {
                            alert('Please enter a valid email address.');
                            return;
                        }
                        
                        // Update user data
                        if (!state.decryptedData.user) {
                            state.decryptedData.user = {};
                        }
                        
                        state.decryptedData.user.name = name;
                        state.decryptedData.user.email = email;
                        state.decryptedData.user.securityQuestion = securityQuestion;
                        state.decryptedData.user.securityAnswer = securityAnswer;
                        
                        // Auto logout setting persistence
                        if (!state.decryptedData.user) state.decryptedData.user = {};
                        state.decryptedData.user.autoLogoutMinutes = state.autoLogoutMinutes;

                        // Mark first-login profile prompt as shown once user visits and saves
                        if (!state.decryptedData.user) state.decryptedData.user = {};
                        state.decryptedData.user.profilePromptShown = true;
                        saveData();
                        showToast('Profile saved successfully!');
                    });
                }

                // Initialize and bind auto-logout controls
                const presetBtns = Array.from(detailsPane.querySelectorAll('.auto-logout-preset'));
                const customInput = detailsPane.querySelector('#auto-logout-custom');

                // Load from saved value if present, otherwise default to 1 minute
                const savedAuto = (state.decryptedData?.user?.autoLogoutMinutes);
                if (typeof savedAuto === 'number') {
                    state.autoLogoutMinutes = savedAuto;
                } else {
                    // Default to 1 minute if no saved value
                    state.autoLogoutMinutes = 1;
                }

                const applySelectionUI = () => {
                    // Check if current value matches any preset
                    const matchingPreset = presetBtns.find(b => Number(b.getAttribute('data-min')) === state.autoLogoutMinutes);
                    
                    presetBtns.forEach(btn => {
                        const m = Number(btn.getAttribute('data-min'));
                        const isActive = m === state.autoLogoutMinutes;
                        btn.classList.toggle('bg-primary-600', isActive);
                        btn.classList.toggle('text-white', isActive);
                        btn.classList.toggle('border-primary-600', isActive);
                        btn.classList.toggle('hover:bg-gray-100', !isActive);
                        btn.classList.toggle('dark:hover:bg-gray-700', !isActive);
                    });
                    
                    if (customInput) {
                        if (matchingPreset) {
                            // Clear custom input if we have a matching preset
                            customInput.value = '';
                        } else {
                            // Show custom value if no preset matches
                            customInput.value = String(state.autoLogoutMinutes ?? '');
                        }
                    }
                };

                presetBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const mins = Number(btn.getAttribute('data-min'));
                        state.autoLogoutMinutes = isNaN(mins) ? 1 : mins;
                        // Clear custom
                        if (customInput) customInput.value = '';
                        // Persist immediately
                        if (!state.decryptedData.user) state.decryptedData.user = {};
                        state.decryptedData.user.autoLogoutMinutes = state.autoLogoutMinutes;
                        saveData();
                        applySelectionUI();
                        updateAutoLockFooter();
                        resetAutoLogoutTimer();
                    });
                });

                if (customInput) {
                    customInput.addEventListener('input', (e) => {
                        // Clear preset selection visually first
                        presetBtns.forEach(b => {
                            b.classList.remove('bg-primary-600','text-white','border-primary-600');
                            b.classList.add('hover:bg-gray-100','dark:hover:bg-gray-700');
                        });
                        
                        const val = Number(e.target.value);
                        if (Number.isFinite(val) && val >= 0) {
                            state.autoLogoutMinutes = val;
                        } else if (e.target.value === '') {
                            // if cleared, default back to 1 minute
                            state.autoLogoutMinutes = 1;
                        }
                        // Persist immediately
                        if (!state.decryptedData.user) state.decryptedData.user = {};
                        state.decryptedData.user.autoLogoutMinutes = state.autoLogoutMinutes;
                        saveData();
                        updateAutoLockFooter();
                        resetAutoLogoutTimer();
                    });
                }

                // Initial UI paint
                applySelectionUI();
                updateAutoLockFooter(); // Ensure footer shows current setting

                // Keep hover consistent for active preset (stay themed)
                presetBtns.forEach(b => {
                    b.addEventListener('mouseenter', () => {
                        const m = Number(b.getAttribute('data-min'));
                        const isActive = m === state.autoLogoutMinutes;
                        if (isActive) {
                            b.classList.remove('hover:bg-gray-100','dark:hover:bg-gray-700');
                        }
                    });
                    b.addEventListener('mouseleave', () => {
                        const m = Number(b.getAttribute('data-min'));
                        const isActive = m === state.autoLogoutMinutes;
                        if (!isActive) {
                            b.classList.add('hover:bg-gray-100','dark:hover:bg-gray-700');
                        }
                    });
                });
            };

            const renderBankCardMockup = (item) => {
                const getBankDomainFromName = (bankName) => {
                    if (!bankName) return null;
                    
                    const name = bankName.toLowerCase().trim();
                    
                    // Comprehensive bank domain mapping
                    const bankDomains = {
                        // US Banks
                        'chase': 'chase.com',
                        'jpmorgan chase': 'chase.com',
                        'jp morgan chase': 'chase.com',
                        'bank of america': 'bankofamerica.com',
                        'wells fargo': 'wellsfargo.com',
                        'citibank': 'citibank.com',
                        'citi': 'citibank.com',
                        'goldman sachs': 'goldmansachs.com',
                        'morgan stanley': 'morganstanley.com',
                        'capital one': 'capitalone.com',
                        'us bank': 'usbank.com',
                        'pnc bank': 'pnc.com',
                        'truist': 'truist.com',
                        'td bank': 'td.com',
                        'regions bank': 'regions.com',
                        'fifth third bank': 'fiftthird.com',
                        'ally bank': 'ally.com',
                        'american express': 'americanexpress.com',
                        'discover': 'discover.com',
                        'navy federal': 'navyfederal.org',
                        'usaa': 'usaa.com',
                        'charles schwab': 'schwab.com',
                        'fidelity': 'fidelity.com',
                        
                        // UK Banks
                        'lloyds': 'lloydsbank.com',
                        'lloyds bank': 'lloydsbank.com',
                        'barclays': 'barclays.co.uk',
                        'hsbc': 'hsbc.co.uk',
                        'natwest': 'natwest.com',
                        'royal bank of scotland': 'rbs.co.uk',
                        'rbs': 'rbs.co.uk',
                        'santander': 'santander.co.uk',
                        'nationwide': 'nationwide.co.uk',
                        'halifax': 'halifax.co.uk',
                        'tesco bank': 'tescobank.com',
                        'metro bank': 'metrobankonline.co.uk',
                        'first direct': 'firstdirect.com',
                        
                        // Canadian Banks
                        'royal bank of canada': 'rbc.com',
                        'rbc': 'rbc.com',
                        'toronto dominion': 'td.com',
                        'bank of nova scotia': 'scotiabank.com',
                        'scotiabank': 'scotiabank.com',
                        'bank of montreal': 'bmo.com',
                        'bmo': 'bmo.com',
                        'canadian imperial bank': 'cibc.com',
                        'cibc': 'cibc.com',
                        
                        // European Banks
                        'deutsche bank': 'deutsche-bank.de',
                        'commerzbank': 'commerzbank.de',
                        'bnp paribas': 'bnpparibas.com',
                        'credit agricole': 'credit-agricole.fr',
                        'societe generale': 'societegenerale.com',
                        'ing': 'ing.com',
                        'abn amro': 'abnamro.com',
                        'rabobank': 'rabobank.com',
                        'unicredit': 'unicredit.it',
                        'intesa sanpaolo': 'intesasanpaolo.com',
                        
                        // Indian Banks
                        'state bank of india': 'sbi.co.in',
                        'sbi': 'sbi.co.in',
                        'hdfc bank': 'hdfcbank.com',
                        'hdfc': 'hdfcbank.com',
                        'icici bank': 'icicibank.com',
                        'icici': 'icicibank.com',
                        'axis bank': 'axisbank.com',
                        'axis': 'axisbank.com',
                        'kotak mahindra': 'kotak.com',
                        'kotak': 'kotak.com',
                        'punjab national bank': 'pnb.bank.in',
                        'pnb': 'pnb.bank.in',
                        'bank of baroda': 'bankofbaroda.in',
                        'canara bank': 'canarabank.com',
                        'union bank': 'unionbankofindia.co.in',
                        'yes bank': 'yesbank.in',
                        'indusind bank': 'indusind.com',
                        
                        // Australian Banks
                        'commonwealth bank': 'commbank.com.au',
                        'cba': 'commbank.com.au',
                        'westpac': 'westpac.com.au',
                        'anz': 'anz.com.au',
                        'national australia bank': 'nab.com.au',
                        'nab': 'nab.com.au',
                        
                        // Other Global Banks
                        'standard chartered': 'standardchartered.com',
                        'credit suisse': 'credit-suisse.com',
                        'ubs': 'ubs.com',
                        'jpmorgan': 'jpmorgan.com',
                        'bank of china': 'boc.cn',
                        'industrial and commercial bank': 'icbc.com.cn',
                        'icbc': 'icbc.com.cn'
                    };
                    
                    // Try exact match first
                    if (bankDomains[name]) {
                        return bankDomains[name];
                    }
                    
                    // Try partial matching for better coverage
                    for (const [bankKey, domain] of Object.entries(bankDomains)) {
                        if (name.includes(bankKey) || bankKey.includes(name.split(' ')[0])) {
                            return domain;
                        }
                    }
                    
                    // Fallback: try constructing domain from name
                    const cleanName = name.replace(/\s*(bank|banking|financial|credit union|cu)\s*/gi, '').replace(/\s+/g, '');
                    if (cleanName.length > 2) {
                        return cleanName + '.com';
                    }
                    
                    return null;
                };
                
                const domain = getBankDomainFromNameEnhanced(item.bankName);
                // Use multiple favicon services for better coverage
                const primaryLogoUrl = domain ? `https://www.google.com/s2/favicons?sz=64&domain_url=${domain}` : '';
                const secondaryLogoUrl = domain ? `https://icon.horse/icon/${domain}` : '';
                const bankLogoUrl = primaryLogoUrl;

                const cardNumber = item.cardNumber || '••••-••••-••••-••••';
                const formattedCardNumber = cardNumber.replace(/\s/g, '').replace(/(.{4})/g, '$1-').trim().slice(0, -1);
                const nameOnAccount = item.nameOnAccount || 'JANE DOE';
                const expiry = item.expiry || '••/••';
                const cvv = item.cvv || '•••';

                const chipSvg = `<svg width="40" height="30" viewBox="0 0 40 30" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="40" height="30" rx="4" fill="#E0E0E0"/><rect x="4" y="4" width="32" height="22" rx="2" fill="#BDBDBD"/><path d="M20 4V10M20 26V20M4 15H12M28 15H36M12 10L28 20M12 20L28 10" stroke="#757575" stroke-width="2"/></svg>`;

                // Card brand logos - using images from static folder with uniform dimensions
                const cardLogos = {
                    'Visa': `<img src="static/visa.png" alt="Visa" class="w-16 h-8 object-contain">`,
                    'Mastercard': `<img src="static/mastercard.png" alt="Mastercard" class="w-16 h-8 object-contain">`,
                    'American Express': `<img src="static/amex.png" alt="American Express" class="w-16 h-8 object-contain">`,
                    'Discover': `<img src="static/discover.png" alt="Discover" class="w-16 h-8 object-contain">`,
                    'Diners Club': `<img src="static/dinersclub.png" alt="Diners Club" class="w-16 h-8 object-contain">`,
                    'JCB': `<img src="static/jcb.png" alt="JCB" class="w-16 h-8 object-contain">`,
                    'UnionPay': `<img src="static/unionpay.png" alt="UnionPay" class="w-16 h-8 object-contain">`,
                    'RuPay': `<img src="static/rupay.png" alt="RuPay" class="w-16 h-8 object-contain">`
                };

                // Get card logo based on stored brand or fallback to number detection
                let cardLogo = '';
                const cardBrand = item.cardBrand || detectCardType(cardNumber);
                if (cardBrand && cardLogos[cardBrand]) {
                    cardLogo = cardLogos[cardBrand];
                }

                return `
                <div class="card-container relative w-full max-w-sm mx-auto mb-12 h-52">
                    <!-- Card Front -->
                    <div class="card-front absolute w-full h-full bg-gradient-to-br from-gray-700 to-gray-900 rounded-xl p-5 text-white shadow-lg font-mono flex flex-col justify-between transition-opacity duration-500 ease-in-out">
                        <div>
                            <div class="flex justify-between items-start">
                                 <p class="text-white/80 font-semibold text-sm">${escapeHTML(item.bankName)}</p>
                                <button class="flip-card-btn icon-btn !text-white/70 hover:!text-white">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/></svg>
                                </button>
                            </div>
                            <div class="flex items-center gap-2 mt-1">
                                ${domain ? `<img src="${primaryLogoUrl}" 
                                    onerror="this.onerror=function(){this.onerror=null;this.style.display='none';};this.src='${secondaryLogoUrl}';" 
                                    class="h-8 object-contain bg-white rounded p-1"/>` : ''}
                            </div>
                            <div class="mt-4 text-xl sm:text-2xl tracking-wider text-center">
                                ${escapeHTML(formattedCardNumber)}
                            </div>
                        </div>
                        <div class="flex justify-between items-end">
                            <div>
                                <p class="text-xs font-light uppercase">Card Holder</p>
                                <p class="text-sm sm:text-base font-medium tracking-wider">${escapeHTML(nameOnAccount.toUpperCase())}</p>
                            </div>
                            <div>
                                <p class="text-xs font-light uppercase">Expires</p>
                                <p class="text-sm sm:text-base font-medium tracking-wider">${escapeHTML(expiry)}</p>
                            </div>
                            <div class="w-auto h-8 flex items-center">
                                ${cardLogo}
                            </div>
                        </div>
                    </div>
                    <!-- Card Back -->
                    <div class="card-back absolute w-full h-full bg-gradient-to-br from-gray-600 to-gray-800 rounded-xl shadow-lg font-mono text-white transition-opacity duration-500 ease-in-out opacity-0 pointer-events-none">
                        <div class="w-full h-10 bg-black mt-6"></div>
                        <div class="px-4 py-2 flex items-center justify-end">
                            <span class="text-xs mr-2">CVV</span>
                            <div class="bg-white text-black text-center italic w-20 px-2 py-1 rounded">
                                ${escapeHTML(cvv)}
                            </div>
                        </div>
                         <button class="flip-card-btn icon-btn !text-white/70 hover:!text-white absolute top-3 right-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/></svg>
                        </button>
                    </div>
                </div>
                `;
            };

            const renderItemDetails = (item) => {
                let detailsHtml = `<div class="space-y-6">`;
                const title = item.title || item.bankName || item.productName || item.idType;

                if (state.currentCategory !== 'banks') {
                    detailsHtml += `<h2 class="text-3xl font-bold">${escapeHTML(title)}</h2>`;
                }

                if (state.currentCategory === 'banks') {
                    detailsHtml += renderBankCardMockup(item);
                }

                // Dynamically build detail fields
                const fields = getFieldsForCategory(state.currentCategory);
                fields.forEach(field => {
                    if (state.currentCategory === 'banks' && ['bankName', 'cardNumber', 'nameOnAccount', 'expiry'].includes(field.id)) {
                        return; // Don't render fields already on the card mockup
                    }
                    if (item[field.id]) {
                        detailsHtml += createDetailField(field.label, item[field.id], field.type === 'password' || field.id === 'cvv');
                    }
                });

                detailsHtml += `
                    <div class="flex justify-end gap-3 pt-4 border-t border-gray-200 dark:border-gray-700">
                        <button id="delete-item-btn" class="px-4 py-2 rounded-lg bg-transparent border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 font-semibold hover:bg-gray-100 dark:hover:bg-gray-700">Delete</button>
                        <button id="edit-item-btn" class="px-4 py-2 rounded-lg bg-primary-600 text-white font-semibold hover:bg-primary-700">Edit</button>
                    </div>
                </div>`;
                detailsPane.innerHTML = detailsHtml;
            };

            const renderForm = (item = null) => {
                const isEditing = item !== null;
                let formHtml = `<div class="space-y-6">`;
                const title = isEditing ? `Edit ${categories[state.currentCategory].name.slice(0, -1)}` : `New ${categories[state.currentCategory].name.slice(0, -1)}`;
                formHtml += `<h2 class="text-3xl font-bold border-b pb-4 border-gray-200 dark:border-gray-700">${title}</h2>`;

                const fields = getFieldsForCategory(state.currentCategory);
                fields.forEach(field => {
                    let value = isEditing ? item[field.id] : '';
                    if (!isEditing && state.decryptedData.user && state.decryptedData.user.name) {
                        if (field.id === 'nameOnAccount' || field.id === 'nameOnId') {
                            value = state.decryptedData.user.name;
                        }
                    }
                    formHtml += createFormField(field, value);
                });

                formHtml += `
                    <div class="flex gap-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                        <button id="save-item-btn" class="flex-1 px-4 py-2 rounded-lg bg-primary-600 text-white font-semibold hover:bg-primary-700">Save</button>
                        <button id="cancel-form-btn" class="flex-1 px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500">Cancel</button>
                    </div>
                </div>`;
                detailsPane.innerHTML = formHtml;

                // Post-render logic for bank dropdown
                if (state.currentCategory === 'banks') {
                    // Setup bank name typeahead functionality
                    if (document.getElementById('form-bankName')) {
                        setupBankNameTypeahead();
                        
                        // If editing, populate the bank name field
                        if (isEditing && item.bankName) {
                            const bankInput = document.getElementById('form-bankName');
                            if (bankInput) {
                                bankInput.value = item.bankName;
                            }
                        }
                    }
                }

                // Legacy bank select handling (for other fields that might still use old approach)
                const bankSelect = document.getElementById('form-bankName-select');
                const otherBankInput = document.getElementById('form-bankName-other-container');
                if (bankSelect && otherBankInput) {
                    if (isEditing && item.bankName && !popularBanks.includes(item.bankName)) {
                        bankSelect.value = 'Other';
                        otherBankInput.style.display = 'block';
                        document.getElementById('form-bankName-other').value = item.bankName;
                    }

                    bankSelect.addEventListener('change', () => {
                        if (bankSelect.value === 'Other') {
                            otherBankInput.style.display = 'block';
                        } else {
                            otherBankInput.style.display = 'none';
                        }
                    });
                }

                // Setup bank name typeahead functionality (moved outside to avoid duplication)
                if (state.currentCategory === 'banks' && document.getElementById('form-bankName')) {
                    setupBankNameTypeahead();
                }
            };

            // Bank name typeahead functionality
            // Bank name typeahead functionality - Completely rewritten for reliability
            function setupBankNameTypeahead() {
                const bankInput = document.getElementById('form-bankName');
                const dropdownBtn = document.getElementById('bank-dropdown-btn');
                const dropdown = document.getElementById('bank-dropdown');

                if (!bankInput || !dropdownBtn || !dropdown) return;

                let isOpen = false;

                // Close dropdown
                function closeDropdown() {
                    dropdown.style.display = 'none';
                    isOpen = false;
                }

                // Open dropdown and show options
                function openDropdown() {
                    isOpen = true;
                    dropdown.style.display = 'block';
                    showBankOptions(bankInput.value);
                }

                // Show bank options (filtered or all)
                function showBankOptions(query = '') {
                    const filtered = query ? 
                        popularBanks.filter(bank => bank.toLowerCase().includes(query.toLowerCase())) : 
                        popularBanks;

                    if (filtered.length > 0) {
                        dropdown.innerHTML = filtered.map(bank => 
                            `<div class="bank-option px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer">${bank}</div>`
                        ).join('');
                    } else if (query) {
                        dropdown.innerHTML = `<div class="px-3 py-2 text-gray-500 dark:text-gray-400 italic">Press Enter to add "${query}"</div>`;
                    }
                }

                // Initialize
                showBankOptions();

                // Dropdown button toggle
                dropdownBtn.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    if (isOpen) {
                        closeDropdown();
                    } else {
                        openDropdown();
                        bankInput.focus();
                    }
                };

                // Input typing
                bankInput.oninput = (e) => {
                    const value = e.target.value;
                    if (value.length > 0) {
                        if (!isOpen) openDropdown();
                        else showBankOptions(value);
                    } else {
                        closeDropdown();
                    }
                };

                // Keyboard handling
                bankInput.onkeydown = (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        if (isOpen) {
                            const firstOption = dropdown.querySelector('.bank-option');
                            if (firstOption) {
                                bankInput.value = firstOption.textContent.trim();
                            }
                        }
                        closeDropdown();
                        handleCustomBankName(bankInput.value);
                    } else if (e.key === 'Escape') {
                        closeDropdown();
                    } else if (e.key === 'ArrowDown' && !isOpen) {
                        e.preventDefault();
                        openDropdown();
                    }
                };

                // Option clicks - Simple and direct
                dropdown.onclick = (e) => {
                    const option = e.target.closest('.bank-option');
                    if (option) {
                        bankInput.value = option.textContent.trim();
                        closeDropdown();
                        setTimeout(() => bankInput.focus(), 0);
                    }
                };

                // Handle blur to close dropdown
                bankInput.addEventListener('blur', (e) => {
                    // Small delay to allow option clicks to register
                    setTimeout(() => {
                        if (isOpen) {
                            closeDropdown();
                            handleCustomBankName(bankInput.value);
                        }
                    }, 150);
                });

                // Handle custom bank discovery
                async function handleCustomBankName(bankName) {
                    if (!bankName || bankName.trim().length === 0) return;
                    
                    const trimmedName = bankName.trim();
                    const existingDomain = getBankDomainFromNameEnhanced(trimmedName);
                    if (existingDomain) return;
                    
                    try {
                        console.log(`Discovering website for: ${trimmedName}`);
                        const domain = await discoverBankWebsite(trimmedName);
                        if (domain) {
                            window.customBankDomains = window.customBankDomains || {};
                            window.customBankDomains[trimmedName.toLowerCase()] = domain;
                        }
                    } catch (error) {
                        console.log(`Discovery failed for ${trimmedName}:`, error);
                    }
                }

                // Simple domain discovery
                async function discoverBankWebsite(bankName) {
                    const cleanName = bankName.toLowerCase()
                        .replace(/bank|banking|financial|credit|union|trust|savings/g, '')
                        .replace(/[^a-z0-9]/g, '');
                    
                    if (cleanName.length > 2) {
                        const domains = [
                            `${cleanName}.com`,
                            `${cleanName}bank.com`,
                            `www.${cleanName}.com`
                        ];

                        for (const domain of domains) {
                            try {
                                const response = await fetch(`https://www.google.com/s2/favicons?domain=${domain}&sz=32`);
                                if (response.ok) return domain;
                            } catch (e) {
                                continue;
                            }
                        }
                    }
                    return null;
                }
            }

            // Global bank domain mapping function
            function getBankDomainFromNameEnhanced(bankName) {
                if (!bankName) return null;
                
                const name = bankName.toLowerCase().trim();
                
                // Comprehensive bank domain mapping
                const bankDomains = {
                    // US Banks
                    'chase': 'chase.com',
                    'jpmorgan chase': 'chase.com',
                    'jp morgan chase': 'chase.com',
                    'bank of america': 'bankofamerica.com',
                    'wells fargo': 'wellsfargo.com',
                    'citibank': 'citibank.com',
                    'citi': 'citibank.com',
                    'goldman sachs': 'goldmansachs.com',
                    'morgan stanley': 'morganstanley.com',
                    'capital one': 'capitalone.com',
                    'us bank': 'usbank.com',
                    'pnc bank': 'pnc.com',
                    'truist': 'truist.com',
                    'td bank': 'td.com',
                    'regions bank': 'regions.com',
                    'fifth third bank': 'fiftthird.com',
                    'ally bank': 'ally.com',
                    'american express': 'americanexpress.com',
                    'discover': 'discover.com',
                    'navy federal': 'navyfederal.org',
                    'usaa': 'usaa.com',
                    'charles schwab': 'schwab.com',
                    'fidelity': 'fidelity.com',
                    
                    // UK Banks
                    'lloyds': 'lloydsbank.com',
                    'lloyds bank': 'lloydsbank.com',
                    'barclays': 'barclays.co.uk',
                    'hsbc': 'hsbc.co.uk',
                    'natwest': 'natwest.com',
                    'royal bank of scotland': 'rbs.co.uk',
                    'rbs': 'rbs.co.uk',
                    'santander': 'santander.co.uk',
                    'nationwide': 'nationwide.co.uk',
                    'halifax': 'halifax.co.uk',
                    'tesco bank': 'tescobank.com',
                    'metro bank': 'metrobankonline.co.uk',
                    'first direct': 'firstdirect.com',
                    
                    // Canadian Banks
                    'royal bank of canada': 'rbc.com',
                    'rbc': 'rbc.com',
                    'toronto dominion': 'td.com',
                    'bank of nova scotia': 'scotiabank.com',
                    'scotiabank': 'scotiabank.com',
                    'bank of montreal': 'bmo.com',
                    'bmo': 'bmo.com',
                    'canadian imperial bank': 'cibc.com',
                    'cibc': 'cibc.com',
                    
                    // European Banks
                    'deutsche bank': 'deutsche-bank.de',
                    'commerzbank': 'commerzbank.de',
                    'bnp paribas': 'bnpparibas.com',
                    'credit agricole': 'credit-agricole.fr',
                    'societe generale': 'societegenerale.com',
                    'ing': 'ing.com',
                    'abn amro': 'abnamro.com',
                    'rabobank': 'rabobank.com',
                    'unicredit': 'unicredit.it',
                    'intesa sanpaolo': 'intesasanpaolo.com',
                    
                    // Indian Banks
                    'state bank of india': 'sbi.co.in',
                    'sbi': 'sbi.co.in',
                    'hdfc bank': 'hdfcbank.com',
                    'hdfc': 'hdfcbank.com',
                    'icici bank': 'icicibank.com',
                    'icici': 'icicibank.com',
                    'axis bank': 'axisbank.com',
                    'axis': 'axisbank.com',
                    'kotak mahindra': 'kotak.com',
                    'kotak': 'kotak.com',
                    'punjab national bank': 'pnbindia.in',
                    'pnb': 'pnbindia.in',
                    'bank of baroda': 'bankofbaroda.in',
                    'canara bank': 'canarabank.com',
                    'union bank': 'unionbankofindia.co.in',
                    'union bank of india': 'unionbankofindia.co.in',
                    'yes bank': 'yesbank.in',
                    'indusind bank': 'indusind.com',
                    
                    // Australian Banks
                    'commonwealth bank': 'commbank.com.au',
                    'cba': 'commbank.com.au',
                    'westpac': 'westpac.com.au',
                    'anz': 'anz.com.au',
                    'national australia bank': 'nab.com.au',
                    'nab': 'nab.com.au',
                    
                    // Other Global Banks
                    'standard chartered': 'standardchartered.com',
                    'credit suisse': 'credit-suisse.com',
                    'ubs': 'ubs.com',
                    'jpmorgan': 'jpmorgan.com',
                    'bank of china': 'boc.cn',
                    'industrial and commercial bank': 'icbc.com.cn',
                    'icbc': 'icbc.com.cn'
                };
                
                // Try exact match first
                if (bankDomains[name]) {
                    return bankDomains[name];
                }
                
                // Try partial matching for better coverage
                for (const [bankKey, domain] of Object.entries(bankDomains)) {
                    if (name.includes(bankKey) || bankKey.includes(name.split(' ')[0])) {
                        return domain;
                    }
                }
                
                // Then check custom discovered domains
                if (window.customBankDomains) {
                    const customDomain = window.customBankDomains[name];
                    if (customDomain) return customDomain;
                }
                
                // Fallback: try constructing domain from name
                const cleanName = name.replace(/\s*(bank|banking|financial|credit union|cu)\s*/gi, '').replace(/\s+/g, '');
                if (cleanName.length > 2) {
                    return cleanName + '.com';
                }
                
                return null;
            };

            // --- UI HELPERS ---
            const getFieldsForCategory = (category) => {
                switch (category) {
                    case 'websites': return [
                        { id: 'title', label: 'Website Name', type: 'text', required: true },
                        { id: 'url', label: 'URL', type: 'text' },
                        { id: 'username', label: 'Username/Email', type: 'text', required: true },
                        { id: 'password', label: 'Password', type: 'password', required: true },
                    ];
                    case 'banks': return [
                        { id: 'bankName', label: 'Bank Name', type: 'select', required: true, options: popularBanks },
                        { id: 'nameOnAccount', label: 'Name on Account', type: 'text' },
                        { id: 'cardNumber', label: 'Card Number', type: 'text' },
                        { id: 'cardBrand', label: 'Card Brand', type: 'select', options: ['Visa', 'Mastercard', 'American Express', 'Discover', 'Diners Club', 'JCB', 'UnionPay', 'RuPay', 'Other'] },
                        { id: 'cardType', label: 'Card Type', type: 'select', options: ['Credit', 'Debit', 'Forex', 'Prepaid', 'Other'] },
                        { id: 'expiry', label: 'Expiry (MM/YY)', type: 'text' },
                        { id: 'cvv', label: 'CVV', type: 'password' },
                        { id: 'pin', label: 'PIN', type: 'password' },
                        { id: 'netBankingPassword', label: 'NetBanking Password', type: 'password' },
                    ];
                    case 'keys': return [
                        { id: 'productName', label: 'Product Name', type: 'text', required: true },
                        { id: 'key', label: 'License Key', type: 'textarea', required: true },
                    ];
                    case 'ids': return [
                        { id: 'idType', label: 'ID Type (e.g., Passport)', type: 'text', required: true },
                        { id: 'idNumber', label: 'ID Number', type: 'text', required: true },
                        { id: 'nameOnId', label: 'Name on ID', type: 'text' },
                    ];
                    default: return [];
                }
            };

            const createFormField = (field, value) => {
                const commonClasses = "w-full px-3 py-2 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-primary-500 focus:outline-none";
                let inputHtml = '';
                if (field.type === 'textarea') {
                    inputHtml = `<textarea id="form-${field.id}" rows="4" class="${commonClasses}" ${field.required ? 'required' : ''}>${escapeHTML(value || '')}</textarea>`;
                } else if (field.type === 'password') {
                    inputHtml = `
                    <div class="relative">
                        <input id="form-${field.id}" type="password" value="${escapeHTML(value || '')}" class="${commonClasses}" ${field.required ? 'required' : ''}>
                        <div class="absolute right-2 top-1/2 -translate-y-1/2 flex items-center gap-1">
                            <button type="button" class="toggle-visibility-btn icon-btn" data-target="form-${field.id}">
                                <svg class="eye-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                                <svg class="eye-off-icon hidden" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>
                            </button>
                        </div>
                    </div>`;
                } else if (field.type === 'select') {
                    if (field.id === 'bankName') {
                        // Special handling for bank name - dropdown with typeahead
                        const options = field.options.map(opt => `<option value="${escapeHTML(opt)}" ${value === opt ? 'selected' : ''}>${escapeHTML(opt)}</option>`).join('');
                        inputHtml = `
                            <div class="relative">
                                <input id="form-${field.id}" type="text" value="${escapeHTML(value || '')}" 
                                    class="${commonClasses}" ${field.required ? 'required' : ''} 
                                    placeholder="Type bank name or select from dropdown"
                                    autocomplete="off">
                                <button type="button" id="bank-dropdown-btn" class="absolute right-2 top-1/2 -translate-y-1/2 p-1 text-gray-400 hover:text-gray-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </button>
                                <div id="bank-dropdown" class="absolute z-10 w-full mt-1 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg shadow-lg max-h-60 overflow-y-auto scrollbar-hidden" style="display: none;">
                                    ${field.options.map(opt => `
                                        <div class="bank-option px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer" data-value="${escapeHTML(opt)}">
                                            ${escapeHTML(opt)}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    } else {
                        // Regular select dropdown
                        const options = field.options.map(opt => `<option value="${escapeHTML(opt)}" ${value === opt ? 'selected' : ''}>${escapeHTML(opt)}</option>`).join('');
                        inputHtml = `
                            <select id="form-${field.id}" class="${commonClasses}" ${field.required ? 'required' : ''}>
                                <option value="">-- Select --</option>
                                ${options}
                            </select>
                        `;
                    }
                }
                else {
                    inputHtml = `<input id="form-${field.id}" type="${field.type}" value="${escapeHTML(value || '')}" class="${commonClasses}" ${field.required ? 'required' : ''}>`;
                }

                return `
                    <div>
                        <label for="form-${field.id}-select" class="block mb-1 text-sm font-medium">${field.label}${field.required ? ' *' : ''}</label>
                        ${inputHtml}
                    </div>
                `;
            };

            const createDetailField = (label, value, isPassword = false) => {
                const displayValue = isPassword ? '••••••••' : escapeHTML(value);
                const fieldId = `detail-${label.replace(/\s+/g, '-')}-${crypto.randomUUID()}`;
                let buttons = `
                    <button class="copy-btn icon-btn" data-value="${escapeHTML(value)}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                    </button>
                `;

                if (isPassword) {
                    buttons += `
                        <button class="toggle-visibility-btn icon-btn" data-target="${fieldId}" data-value="${escapeHTML(value)}">
                            <svg class="eye-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                            <svg class="eye-off-icon hidden" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>
                        </button>
                    `;
                }

                return `
                    <div class="flex flex-col">
                        <label class="text-sm font-medium text-gray-500 dark:text-gray-400">${label}</label>
                        <div class="flex items-center gap-2 mt-1">
                            <p id="${fieldId}" class="text-lg font-mono flex-grow break-all">${displayValue}</p>
                            ${buttons}
                        </div>
                    </div>
                `;
            };

            const escapeHTML = str => (str || '').toString().replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[m]);

            const showToast = (message) => {
                const toast = document.createElement('div');
                toast.className = 'fixed bottom-5 right-5 bg-primary-600 text-white px-4 py-2 rounded-lg shadow-lg animate-pulse';
                toast.textContent = message;
                document.body.appendChild(toast);
                setTimeout(() => {
                    toast.remove();
                }, 2000);
            };

            let clipboardClearTimer = null;
            let autoLogoutTimer = null;

            const resetAutoLogoutTimer = () => {
                if (autoLogoutTimer) {
                    clearTimeout(autoLogoutTimer);
                }

                // Only set timer if vault is unlocked
                if (!state.isLocked) {
                    // Honor exact values (including 0 = disabled). Fallback to 1 only if invalid.
                    let mins = Number(state.autoLogoutMinutes);
                    if (!Number.isFinite(mins) || mins < 0) mins = 1;
                    if (mins === 0) {
                        // Disabled
                        updateAutoLockFooter();
                        return;
                    }
                    const ms = Math.max(0, mins) * 60 * 1000;
                    autoLogoutTimer = setTimeout(() => {
                        console.log('Auto logout triggered due to inactivity');
                        state.isLocked = true;
                        state.masterPassword = null;
                        state.decryptedData = null;
                        state.selectedItemId = null;
                        showToast('Vault locked due to inactivity');
                        render();
                    }, ms);
                }
            };

            const copyToClipboardWithTimeout = (text, timeout = 30000) => {
                navigator.clipboard.writeText(text).then(() => {
                    showToast('Copied to clipboard!');

                    if (clipboardClearTimer) {
                        clearTimeout(clipboardClearTimer);
                    }

                    clipboardClearTimer = setTimeout(() => {
                        navigator.clipboard.writeText(' ').then(() => {
                            console.log('Clipboard cleared after timeout.');
                            showToast('Clipboard cleared for security.');
                        });
                    }, timeout);
                }).catch(err => {
                    console.error('Failed to copy text: ', err);
                    showToast('Failed to copy!');
                });
            };

            const updateResponsiveLayout = () => {
                const isMobile = window.innerWidth < 768;
                if (!isMobile) {
                    itemListContainer.classList.remove('mobile-hidden');
                    detailsPaneContainer.classList.remove('mobile-hidden');
                    return;
                }

                if (state.selectedItemId || state.currentCategory === 'passwordGenerator' || state.currentCategory === 'profile') {
                    itemListContainer.classList.add('mobile-hidden');
                    detailsPaneContainer.classList.remove('mobile-hidden');
                } else {
                    itemListContainer.classList.remove('mobile-hidden');
                    detailsPaneContainer.classList.add('mobile-hidden');
                }
            };

            // --- EVENT HANDLERS ---
            // Global Search behavior
            const openGlobalSearch = () => {
                if (state.isLocked) return;
                globalSearchBackdrop.style.display = 'flex';
                globalSearchResults.innerHTML = '';
                globalSearchInput.value = '';
                setTimeout(() => globalSearchInput.focus(), 0);
                updateGlobalSearchResults('');
            };

            const closeGlobalSearch = () => {
                globalSearchBackdrop.style.display = 'none';
            };

            const entryDisplayForCategory = (cat, item) => {
                const title = item.title || item.bankName || item.productName || item.idType || 'Untitled';
                let subtitle = '';
                if (cat === 'websites') subtitle = item.username || item.url || '';
                else if (cat === 'banks') {
                    const lastFour = item.cardNumber ? '•••• ' + (item.cardNumber.replace(/\s/g, '').slice(-4)) : '';
                    subtitle = [lastFour, item.nameOnAccount].filter(Boolean).join(' \u00B7 ');
                } else if (cat === 'keys') subtitle = 'License Key';
                else if (cat === 'ids') subtitle = item.idNumber || '';
                return { title, subtitle };
            };

            const collectAllEntries = () => {
                if (!state.decryptedData) return [];
                const cats = ['websites','banks','keys','ids'];
                const all = [];
                cats.forEach(cat => {
                    const arr = state.decryptedData[cat] || [];
                    arr.forEach(item => {
                        const { title, subtitle } = entryDisplayForCategory(cat, item);
                        all.push({
                            id: item.id,
                            cat,
                            title: title || '',
                            subtitle: subtitle || '',
                            raw: item
                        });
                    });
                });
                return all;
            };

            const simpleScore = (q, text) => {
                if (!q) return 1;
                const s = text.toLowerCase();
                const t = q.toLowerCase().trim();
                if (!t) return 1;
                if (s.includes(t)) return 3; // strong match
                // token-based partials
                const parts = t.split(/\s+/);
                let hits = 0;
                for (const p of parts) { if (p && s.includes(p)) hits++; }
                return hits;
            };

            const updateGlobalSearchResults = (query) => {
                const data = collectAllEntries();
                // Rank across title + subtitle
                const ranked = data.map(r => ({
                    ...r,
                    score: simpleScore(query, r.title + ' ' + r.subtitle)
                }))
                .filter(r => r.score > 0)
                .sort((a,b) => b.score - a.score)
                .slice(0, 50);

                if (ranked.length === 0) {
                    globalSearchResults.innerHTML = `<div class="p-4 text-sm text-gray-500">No results</div>`;
                    return;
                }

                const catLabel = (c) => (categories[c]?.name) || c;
                globalSearchResults.innerHTML = ranked.map((r, idx) => `
                    <button class="w-full text-left px-4 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 focus:bg-gray-100 dark:focus:bg-gray-700 flex items-start gap-3 ${idx===0?'ring-1 ring-inset ring-transparent':''}" data-id="${r.id}" data-cat="${r.cat}">
                        <div class="mt-0.5 text-xs px-2 py-0.5 rounded bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 flex-shrink-0">${catLabel(r.cat)}</div>
                        <div class="min-w-0">
                            <div class="font-medium truncate">${escapeHTML(r.title)}</div>
                            ${r.subtitle?`<div class="text-xs text-gray-500 dark:text-gray-400 truncate">${escapeHTML(r.subtitle)}</div>`:''}
                        </div>
                    </button>
                `).join('');

                // Keyboard navigation state
                activeResultIndex = 0;
                updateActiveResultVisual();
            };

            let activeResultIndex = -1;
            const updateActiveResultVisual = () => {
                const items = Array.from(globalSearchResults.querySelectorAll('button[data-id]'));
                items.forEach((el, i) => {
                    const isActive = i === activeResultIndex;
                    el.classList.toggle('bg-gray-100', isActive);
                    el.classList.toggle('dark:bg-gray-700', isActive);
                });
                const active = items[activeResultIndex];
                if (active) active.scrollIntoView({ block: 'nearest' });
            };

            const navigateToResult = (el) => {
                if (!el) return;
                const id = el.getAttribute('data-id');
                const cat = el.getAttribute('data-cat');
                closeGlobalSearch();

                // Switch category and open item
                state.currentCategory = cat;
                state.selectedItemId = id;
                // Filter the list using current global query
                const q = globalSearchInput?.value || '';
                state.searchTerm = q;
                if (searchBar) searchBar.value = q;
                render();

                // After render, flash highlight the category button and item card
                setTimeout(() => {
                    // Highlight category button
                    const catButtons = Array.from(document.querySelectorAll('#category-nav button'));
                    const btn = catButtons.find(b => (b.textContent || '').includes(categories[cat]?.name));
                    if (btn) {
                        btn.classList.add('flash-highlight');
                        setTimeout(() => btn.classList.remove('flash-highlight'), 1700);
                    }
                    // Highlight item card
                    const card = document.querySelector(`.item-card[data-id="${CSS.escape(id)}"]`);
                    if (card) {
                        card.classList.add('flash-highlight');
                        card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        setTimeout(() => card.classList.remove('flash-highlight'), 1700);
                    }
                }, 50);
            };

            globalSearchBtn?.addEventListener('click', openGlobalSearch);
            globalSearchClose?.addEventListener('click', closeGlobalSearch);
            globalSearchBackdrop?.addEventListener('click', (e) => {
                if (e.target === globalSearchBackdrop) closeGlobalSearch();
            });
            document.addEventListener('keydown', (e) => {
                // Ctrl+/ opens global search
                if ((e.ctrlKey || e.metaKey) && e.key === '/') {
                    e.preventDefault();
                    openGlobalSearch();
                }
            });
            globalSearchInput?.addEventListener('input', (e) => {
                updateGlobalSearchResults(e.target.value);
            });
            globalSearchResults?.addEventListener('click', (e) => {
                const row = e.target.closest('button[data-id]');
                if (row) navigateToResult(row);
            });
            globalSearchInput?.addEventListener('keydown', (e) => {
                const items = Array.from(globalSearchResults.querySelectorAll('button[data-id]'));
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    if (items.length) {
                        activeResultIndex = Math.min(items.length - 1, activeResultIndex + 1);
                        updateActiveResultVisual();
                    }
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    if (items.length) {
                        activeResultIndex = Math.max(0, activeResultIndex - 1);
                        updateActiveResultVisual();
                    }
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (items[activeResultIndex]) navigateToResult(items[activeResultIndex]);
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    closeGlobalSearch();
                }
            });
            masterPasswordForm.addEventListener('submit', (e) => {
                e.preventDefault();
                passwordError.textContent = '';
                const password = masterPasswordInput.value;

                if (state.hasVault) {
                    // Unlock
                    const encryptedData = localStorage.getItem('vaultData');

                    if (!encryptedData) {
                        passwordError.textContent = 'No vault data found. Please create a new vault.';
                        return;
                    }

                    const decrypted = decrypt(encryptedData, password);
                    if (decrypted) {
                        state.decryptedData = decrypted;
                        state.masterPassword = password;
                        state.isLocked = false;
                        // Load saved auto logout preference if present; if missing, default to 1 and persist
                        const savedAuto = state.decryptedData?.user?.autoLogoutMinutes;
                        if (typeof savedAuto === 'number') {
                            state.autoLogoutMinutes = savedAuto;
                        } else {
                            state.autoLogoutMinutes = 1;
                            if (!state.decryptedData.user) state.decryptedData.user = {};
                            state.decryptedData.user.autoLogoutMinutes = 1;
                            saveData();
                        }
            // One-time onboarding redirect to Profile if not completed before
                        try {
                            if (!state.decryptedData.user) state.decryptedData.user = {};
                            if (state.decryptedData.user.onboardingCompleted !== true) {
                                state.currentCategory = 'profile';
                                state.decryptedData.user.onboardingCompleted = true;
                                saveData();
                            }
                        } catch (_) {}
                        resetAutoLogoutTimer(); // Start auto logout timer
                        render();
                    } else {
                        passwordError.textContent = 'Invalid password. Please try again.';
                    }
                } else {
                    // Create vault
                    const userName = document.getElementById('user-name').value;
                    const confirmPassword = confirmMasterPasswordInput.value;
                    if (!userName) {
                        passwordError.textContent = 'Please enter your name.';
                        return;
                    }
                    if (password.length < 8) {
                        passwordError.textContent = 'Password must be at least 8 characters long.';
                        return;
                    }
                    if (password !== confirmPassword) {
                        passwordError.textContent = 'Passwords do not match.';
                        return;
                    }
                    state.decryptedData = { 
                        user: { 
                            name: userName,
                            email: '',
                            securityQuestion: '',
                            securityAnswer: '',
                            autoLogoutMinutes: 1,
                            onboardingCompleted: false,
                            profilePromptShown: false
                        }, 
                        websites: [], 
                        banks: [], 
                        keys: [], 
                        ids: [] 
                    };
                    state.masterPassword = password;
                    state.isLocked = false;
                    state.autoLogoutMinutes = 1;
                    // Redirect to Profile on first onboarding only in this initial session
                    state.currentCategory = 'profile';
                    // Mark onboarding completed (banner will show once on first profile render)
                    try {
                        if (!state.decryptedData.user) state.decryptedData.user = {};
                        state.decryptedData.user.onboardingCompleted = true;
                    } catch (_) {}
                    saveData();
                    resetAutoLogoutTimer(); // Start auto logout timer for new vault
                    render();
                }
            });

            document.getElementById('forgot-password-btn').addEventListener('click', () => {
                modalBackdrop.style.display = 'flex';
                forgotPasswordModal.style.display = 'block';
            });

            addNewItemBtn.addEventListener('click', () => {
                state.selectedItemId = 'new';
                renderDetailsPane();
            });

            itemList.addEventListener('click', (e) => {
                const card = e.target.closest('.item-card');
                if (card) {
                    state.selectedItemId = card.dataset.id;
                    renderItemList(); // re-render list for active state
                    renderDetailsPane();
                }
            });

            detailsPane.addEventListener('click', e => {
                // Card Flip
                if (e.target.closest('.flip-card-btn')) {
                    const container = e.target.closest('.card-container');
                    const front = container.querySelector('.card-front');
                    const back = container.querySelector('.card-back');
                    front.classList.toggle('opacity-0');
                    front.classList.toggle('pointer-events-none');
                    back.classList.toggle('opacity-0');
                    back.classList.toggle('pointer-events-none');
                }

                // Save/Cancel
                if (e.target.id === 'save-item-btn') {
                    const newItem = { id: state.selectedItemId === 'new' ? crypto.randomUUID() : state.selectedItemId };
                    const fields = getFieldsForCategory(state.currentCategory);
                    let isValid = true;

                    fields.forEach(field => {
                        let value = null;
                        let isFieldValid = true;

                        if (field.type === 'select') {
                            if (field.id === 'bankName') {
                                // Handle new bank name typeahead field
                                const bankInput = document.getElementById(`form-${field.id}`);
                                if (bankInput) {
                                    value = bankInput.value;
                                    if (field.required && !value) isFieldValid = false;
                                }
                            } else {
                                // Handle regular select fields
                                const select = document.getElementById(`form-${field.id}`);
                                if (select) {
                                    if (select.value === 'Other' && document.getElementById(`form-${field.id}-other`)) {
                                        const otherInput = document.getElementById(`form-${field.id}-other`);
                                        value = otherInput.value;
                                        if (field.required && !value) isFieldValid = false;
                                    } else {
                                        value = select.value;
                                        if (field.required && !value) isFieldValid = false;
                                    }
                                }
                            }
                        } else {
                            const input = document.getElementById(`form-${field.id}`);
                            if (input) {
                                value = input.value;
                                if (field.required && !value) isFieldValid = false;
                            }
                        }

                        newItem[field.id] = value;
                        if (!isFieldValid) {
                            isValid = false;
                        }
                    });


                    if (state.currentCategory === 'banks') {
                        const expiryInput = document.getElementById('form-expiry');
                        if (expiryInput && expiryInput.value) {
                            const [month, year] = expiryInput.value.split('/');
                            if (!month || !year || isNaN(month) || isNaN(year) || month < 1 || month > 12 || year.length !== 2) {
                                alert('Invalid expiry date format. Please use MM/YY.');
                                isValid = false;
                            } else {
                                const expiryDate = new Date(`20${year}`, month, 0); // Day 0 gives last day of previous month
                                const now = new Date();
                                if (expiryDate < now) {
                                    alert('Expiry date cannot be in the past.');
                                    isValid = false;
                                }
                            }
                        }
                    }

                    if (!isValid) {
                        alert('Please fill all required fields correctly.');
                        return;
                    }

                    if (state.selectedItemId === 'new') {
                        if (!state.decryptedData[state.currentCategory]) {
                            state.decryptedData[state.currentCategory] = [];
                        }
                        state.decryptedData[state.currentCategory].push(newItem);
                    } else {
                        const index = state.decryptedData[state.currentCategory].findIndex(i => i.id === state.selectedItemId);
                        state.decryptedData[state.currentCategory][index] = newItem;
                    }
                    saveData();
                    state.selectedItemId = newItem.id;
                    render();
                }
                if (e.target.id === 'cancel-form-btn') {
                    state.selectedItemId = null;
                    render();
                }
                // Edit/Delete
                if (e.target.id === 'edit-item-btn') {
                    const item = state.decryptedData[state.currentCategory].find(i => i.id === state.selectedItemId);
                    renderForm(item);
                }
                if (e.target.id === 'delete-item-btn') {
                    // Show custom delete confirmation modal
                    const currentItem = state.decryptedData[state.currentCategory].find(i => i.id === state.selectedItemId);
                    if (currentItem) {
                        // Get the appropriate name based on credential type
                        const itemName = currentItem.name || currentItem.website || currentItem.bankName || currentItem.service || currentItem.title || 'this item';
                        deleteItemName.textContent = itemName;
                        deleteConfirmModal.style.display = 'block';
                        modalBackdrop.style.display = 'flex';
                    }
                }
                // Copy
                if (e.target.closest('.copy-btn')) {
                    const value = e.target.closest('.copy-btn').dataset.value;
                    copyToClipboardWithTimeout(value);
                }

                // Toggle password visibility
                const toggleBtn = e.target.closest('.toggle-visibility-btn');
                if (toggleBtn) {
                    const targetId = toggleBtn.dataset.target;
                    const targetEl = document.getElementById(targetId);
                    const eyeIcon = toggleBtn.querySelector('.eye-icon');
                    const eyeOffIcon = toggleBtn.querySelector('.eye-off-icon');

                    if (targetEl.tagName === 'INPUT') { // Form view
                        const isPassword = targetEl.type === 'password';
                        targetEl.type = isPassword ? 'text' : 'password';
                        eyeIcon.classList.toggle('hidden', isPassword);
                        eyeOffIcon.classList.toggle('hidden', !isPassword);
                    } else { // Detail view
                        const isHidden = targetEl.textContent === '••••••••';
                        targetEl.textContent = isHidden ? toggleBtn.dataset.value : '••••••••';
                        eyeIcon.classList.toggle('hidden', isHidden);
                        eyeOffIcon.classList.toggle('hidden', !isHidden);
                    }
                }
            });

            detailsPane.addEventListener('input', e => {
                if (e.target.id === 'form-cardNumber') {
                    let value = e.target.value.replace(/\D/g, ''); // remove non-digits
                    value = value.substring(0, 16); // limit to 16 digits
                    e.target.value = value.replace(/(.{4})/g, '$1 ').trim();

                    const cardBrandSelect = document.getElementById('form-cardBrand');
                    const cardTypeSelect = document.getElementById('form-cardType');
                    
                    if (value.length === 0) {
                        // Clear auto-detected card brand when card number is empty
                        // Clear if: brand is set but type is empty (auto-detected) OR if both are from detection
                        if (cardBrandSelect && cardBrandSelect.value) {
                            // Check if the current brand value could be from auto-detection
                            const currentBrand = cardBrandSelect.value;
                            const brandOptions = ['Visa', 'Mastercard', 'American Express', 'Discover', 'Diners Club', 'JCB', 'UnionPay', 'RuPay'];
                            
                            // Clear if it's a detectable brand (suggesting it was auto-filled)
                            if (brandOptions.includes(currentBrand)) {
                                cardBrandSelect.value = '';
                            }
                        }
                    } else {
                        // Auto-detect card brand when card number is entered
                        const cardBrand = detectCardType(value);
                        
                        // Auto-fill if: 
                        // 1. Both fields are empty (new entry) OR
                        // 2. Card brand is empty but card type has value (edit mode after clearing brand) OR  
                        // 3. Card brand is empty regardless of card type (allows re-detection after clearing)
                        if (cardBrandSelect && cardBrand && !cardBrandSelect.value) {
                            const option = Array.from(cardBrandSelect.options).find(opt => opt.value === cardBrand);
                            if (option) {
                                cardBrandSelect.value = cardBrand;
                            } else if (cardBrand !== 'Unknown' && cardBrand !== '') {
                                // If it's a valid card brand but not in dropdown, add it
                                const newOption = new Option(cardBrand, cardBrand);
                                cardBrandSelect.add(newOption);
                                cardBrandSelect.value = cardBrand;
                            }
                        }
                    }
                }
                if (e.target.id === 'form-expiry') {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length > 2) {
                        value = value.slice(0, 2) + '/' + value.slice(2, 4);
                    }
                    e.target.value = value;
                }
            });

            searchBar.addEventListener('input', (e) => {
                state.searchTerm = e.target.value;
                renderItemList();
            });

            lockButton.addEventListener('click', () => {
                if (autoLogoutTimer) {
                    clearTimeout(autoLogoutTimer);
                }
                state.isLocked = true;
                state.masterPassword = null;
                state.decryptedData = null;
                state.selectedItemId = null;
                render();
            });

            // --- RESPONSIVE HANDLERS ---
            mobileMenuBtn.addEventListener('click', () => {
                navSidebar.classList.add('is-open');
                mobileOverlay.style.display = 'block';
            });

            mobileOverlay.addEventListener('click', () => {
                navSidebar.classList.remove('is-open');
                mobileOverlay.style.display = 'none';
            });

            mobileBackBtn.addEventListener('click', () => {
                state.selectedItemId = null;
                render();
            });

            window.addEventListener('resize', () => {
                if (window.innerWidth >= 1024) {
                    navSidebar.classList.remove('is-open');
                    mobileOverlay.style.display = 'none';
                }
                renderItemList();
                updateResponsiveLayout();
            });

            // --- MODAL & FEATURE LOGIC ---

            // Forgot Password Modal
            document.getElementById('cancel-forgot-modal').addEventListener('click', () => {
                modalBackdrop.style.display = 'none';
                forgotPasswordModal.style.display = 'none';
            });

            document.getElementById('proceed-to-wipe-btn').addEventListener('click', () => {
                forgotPasswordModal.style.display = 'none';
                panicModal.style.display = 'block';
            });

            const exportEncryptedData = () => {
                if (!state.decryptedData || !state.decryptedData.user || !state.decryptedData.user.email || !state.decryptedData.user.securityQuestion || !state.decryptedData.user.securityAnswer) {
                    alert('Please complete your profile settings first (Profile & Security section) before exporting.');
                    return;
                }

                // Create export data with security metadata
                const exportData = {
                    vaultData: state.decryptedData,
                    exportMetadata: {
                        userName: state.decryptedData.user.name,
                        userEmail: state.decryptedData.user.email,
                        securityQuestion: state.decryptedData.user.securityQuestion,
                        exportDate: new Date().toISOString(),
                        version: '2.0'
                    }
                };

                // Create composite key for enhanced security
                const compositeKey = state.masterPassword + state.decryptedData.user.email + state.decryptedData.user.securityAnswer;
                const encryptedExport = encrypt(exportData, compositeKey);
                
                const blob = new Blob([encryptedExport], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `vault-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast('Secure backup exported successfully!');
            };

            document.getElementById('export-from-forgot-btn').addEventListener('click', exportEncryptedData);


            // Panic Button
            document.getElementById('cancel-panic')?.addEventListener('click', () => {
                modalBackdrop.style.display = 'none';
                panicModal.style.display = 'none';
                document.getElementById('panic-confirm-input').value = '';
                document.getElementById('confirm-panic').disabled = true;
            });
            document.getElementById('panic-confirm-input')?.addEventListener('input', (e) => {
                document.getElementById('confirm-panic').disabled = e.target.value !== 'DELETE';
            });
            document.getElementById('confirm-panic')?.addEventListener('click', () => {
                localStorage.removeItem('vaultData');
                window.location.reload();
            });

            // Import/Export
            document.getElementById('import-export-button')?.addEventListener('click', () => {
                modalBackdrop.style.display = 'flex';
                importExportModal.style.display = 'block';
                const statusEl = document.getElementById('import-status');
                const fileInput = document.getElementById('import-file-input');

                // Reset status and file input when opening modal
                statusEl.textContent = '';
                statusEl.className = 'text-sm h-4 text-center';
                if (fileInput) fileInput.value = '';
            });
            document.getElementById('close-import-export-modal')?.addEventListener('click', () => {
                modalBackdrop.style.display = 'none';
                importExportModal.style.display = 'none';

                // Reset file input when manually closing modal
                const fileInput = document.getElementById('import-file-input');
                if (fileInput) fileInput.value = '';
            });
            document.getElementById('export-data-btn')?.addEventListener('click', () => {
                if (!state.masterPassword) {
                    alert('Please unlock the vault to export data.');
                    return;
                }
                exportEncryptedData();
            });

            // Import verification form handler
            document.getElementById('import-verification-form')?.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const verifyEmail = document.getElementById('verify-email').value.trim();
                const verifyAnswer = document.getElementById('verify-security-answer').value.trim();
                const errorEl = document.getElementById('verification-error');
                
                if (!verifyEmail || !verifyAnswer) {
                    errorEl.textContent = 'Please provide both email and security answer.';
                    return;
                }
                
                try {
                    // Create composite key with provided credentials
                    const compositeKey = state.masterPassword + verifyEmail + verifyAnswer;
                    const decryptedImport = decrypt(window.tempImportData, compositeKey);
                    
                    if (decryptedImport && decryptedImport.vaultData && decryptedImport.exportMetadata) {
                        // Verify that the provided email matches the export metadata
                        if (decryptedImport.exportMetadata.userEmail.toLowerCase() !== verifyEmail.toLowerCase()) {
                            errorEl.textContent = 'Email address does not match the export owner.';
                            return;
                        }
                        
                        // Successfully verified and decrypted
                        state.decryptedData = decryptedImport.vaultData;
                        saveData();
                        
                        // Close modals and show success
                        modalBackdrop.style.display = 'none';
                        importVerificationModal.style.display = 'none';
                        
                        // Clear temporary data
                        delete window.tempImportData;
                        
                        showToast('Vault imported successfully!');
                        render();
                        
                    } else {
                        errorEl.textContent = 'Verification failed. Please check your email and security answer.';
                    }
                } catch (error) {
                    console.error('Import verification error:', error);
                    errorEl.textContent = 'Import failed. Please check your credentials.';
                }
            });
            
            document.getElementById('cancel-verification-btn')?.addEventListener('click', () => {
                modalBackdrop.style.display = 'none';
                importVerificationModal.style.display = 'none';
                delete window.tempImportData;
                
                // Reset import modal
                const statusEl = document.getElementById('import-status');
                statusEl.textContent = '';
                statusEl.className = 'text-sm h-4 text-center';
                document.getElementById('import-file-input').value = '';
            });

            document.getElementById('confirm-delete-btn')?.addEventListener('click', () => {
                // Perform the actual deletion
                state.decryptedData[state.currentCategory] = state.decryptedData[state.currentCategory].filter(i => i.id !== state.selectedItemId);
                saveData();
                state.selectedItemId = null;

                // Close modal and refresh view
                modalBackdrop.style.display = 'none';
                deleteConfirmModal.style.display = 'none';
                render();
            });

            // Cancel delete - simply close the modal and backdrop
            document.getElementById('cancel-delete-btn')?.addEventListener('click', () => {
                deleteConfirmModal.style.display = 'none';
                modalBackdrop.style.display = 'none';
            });

            // Modal backdrop click to close
            modalBackdrop.addEventListener('click', (e) => {
                if (e.target === modalBackdrop) {
                    modalBackdrop.style.display = 'none';
                    forgotPasswordModal.style.display = 'none';
                    panicModal.style.display = 'none';
                    importExportModal.style.display = 'none';
                    importVerificationModal.style.display = 'none';
                    deleteConfirmModal.style.display = 'none';
                    
                    // Clean up any temporary import data
                    if (window.tempImportData) {
                        delete window.tempImportData;
                        document.getElementById('import-file-input').value = '';
                    }
                }
            });

            document.getElementById('import-file-input').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const statusEl = document.getElementById('import-status');
                statusEl.textContent = 'Reading file...';
                statusEl.className = 'text-sm h-4 text-center text-[var(--primary-500)]';

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedRawData = event.target.result;
                        
                        // Check if it's the new secure format (starts with our encrypted structure)
                        // New format will be a direct encrypted string, old format might be JSON
                        let isNewSecureFormat = false;
                        
                        try {
                            // Try to parse as JSON - if it succeeds, it might be old format or malformed
                            const testParse = JSON.parse(importedRawData);
                            // If it parses as JSON, it's likely old format or corrupted
                            isNewSecureFormat = false;
                        } catch (e) {
                            // If it doesn't parse as JSON, it's likely our new encrypted string format
                            isNewSecureFormat = true;
                        }
                        
                        if (isNewSecureFormat) {
                            // New secure format - show verification modal
                            statusEl.textContent = 'Secure format detected. Verification required.';
                            statusEl.className = 'text-sm h-4 text-center text-[var(--primary-500)]';
                            
                            // Store the raw data temporarily for verification
                            window.tempImportData = importedRawData;
                            
                            // Show generic security question message
                            document.getElementById('security-question-display').textContent = 'Please enter the answer to your security question as set in your profile.';
                            
                            // Close import modal and show verification modal
                            importExportModal.style.display = 'none';
                            importVerificationModal.style.display = 'block';
                            
                            // Clear previous form data
                            document.getElementById('verify-email').value = '';
                            document.getElementById('verify-security-answer').value = '';
                            document.getElementById('verification-error').textContent = '';
                            
                        } else {
                            // Try legacy format
                            statusEl.textContent = 'Legacy format detected. Processing...';
                            const decrypted = decrypt(importedRawData, state.masterPassword);
                            
                            if (decrypted) {
                                state.decryptedData = decrypted;
                                saveData();
                                statusEl.textContent = 'Import successful!';
                                statusEl.className = 'text-sm h-4 text-center text-green-500';
                                showToast('Legacy vault imported successfully!');
                                
                                setTimeout(() => {
                                    modalBackdrop.style.display = 'none';
                                    importExportModal.style.display = 'none';
                                    statusEl.textContent = '';
                                    statusEl.className = 'text-sm h-4 text-center';
                                    e.target.value = '';
                                    render();
                                }, 1500);
                                return;
                            } else {
                                throw new Error('Invalid legacy format or wrong password');
                            }
                        }
                        
                    } catch (error) {
                        console.error('Import error:', error);
                        statusEl.textContent = 'Import failed: Invalid file format or wrong password.';
                        statusEl.className = 'text-sm h-4 text-center text-red-500';
                        e.target.value = '';
                    }
                };

                reader.onerror = () => {
                    statusEl.textContent = 'Import failed: Could not read file.';
                    statusEl.className = 'text-sm h-4 text-center text-red-500';
                    e.target.value = '';
                };

                reader.readAsText(file);
            });

            // Password Generator
            const generateAndDisplayPassword = () => {
                const lengthSlider = document.getElementById('generator-length-slider');
                const optUppercase = document.getElementById('generator-opt-uppercase');
                const optLowercase = document.getElementById('generator-opt-lowercase');
                const optNumbers = document.getElementById('generator-opt-numbers');
                const optSymbols = document.getElementById('generator-opt-symbols');
                const output = document.getElementById('generator-output');

                if (!lengthSlider || !output) return;

                const length = lengthSlider.value;
                const chars = {
                    uppercase: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ',
                    lowercase: 'abcdefghijklmnopqrstuvwxyz',
                    numbers: '0123456789',
                    symbols: '!@#$%^&*()_+~`|}{[]:;?><,./-='
                };
                let charset = '';
                if (optUppercase.checked) charset += chars.uppercase;
                if (optLowercase.checked) charset += chars.lowercase;
                if (optNumbers.checked) charset += chars.numbers;
                if (optSymbols.checked) charset += chars.symbols;
                if (charset === '') {
                    output.value = 'Select at least one option';
                    updatePasswordStrength(); // Update strength meter to show weak
                    return;
                }
                let password = '';
                for (let i = 0; i < length; i++) {
                    password += charset.charAt(Math.floor(Math.random() * charset.length));
                }
                output.value = password;

                // New features: save to history and update strength
                savePasswordToHistory(password);
                updatePasswordStrength();
            };

            const setupPasswordGeneratorListeners = () => {
                const lengthSlider = document.getElementById('generator-length-slider');
                const lengthValue = document.getElementById('generator-length-value');
                const regenerateBtn = document.getElementById('regenerate-password-btn');
                const copyBtn = document.getElementById('copy-generated-password-btn');
                const checkboxes = document.querySelectorAll('#generator-opt-uppercase, #generator-opt-lowercase, #generator-opt-numbers, #generator-opt-symbols');
                const passphraseBtn = document.getElementById('generate-passphrase-btn');
                const pinBtn = document.getElementById('generate-pin-btn');
                const clearHistoryBtn = document.getElementById('clear-history-btn');

                if (!lengthSlider) return;

                lengthSlider.addEventListener('input', () => {
                    lengthValue.textContent = lengthSlider.value;
                    generateAndDisplayPassword();
                    updatePasswordStrength();
                });

                checkboxes.forEach(cb => cb.addEventListener('change', () => {
                    generateAndDisplayPassword();
                    updatePasswordStrength();
                }));

                regenerateBtn.addEventListener('click', () => {
                    generateAndDisplayPassword();
                    updatePasswordStrength();
                });

                copyBtn.addEventListener('click', () => {
                    const password = document.getElementById('generator-output').value;
                    copyToClipboardWithTimeout(password);
                });

                if (passphraseBtn) {
                    passphraseBtn.addEventListener('click', generatePassphrase);
                }

                if (pinBtn) {
                    pinBtn.addEventListener('click', generatePIN);
                }

                if (clearHistoryBtn) {
                    clearHistoryBtn.addEventListener('click', clearPasswordHistory);
                }
            };

            // Password strength analysis
            const analyzePasswordStrength = (password) => {
                if (!password || password === 'Select at least one option') {
                    return {
                        score: 0,
                        feedback: ['✗ No password generated', '✗ Please select character types']
                    };
                }

                let score = 0;
                const feedback = [];

                // Length scoring (enhanced)
                if (password.length >= 24) {
                    score += 35;
                    feedback.push('✓ Excellent length (24+ characters)');
                } else if (password.length >= 16) {
                    score += 25;
                    feedback.push('✓ Good length (16+ characters)');
                } else if (password.length >= 12) {
                    score += 15;
                    feedback.push('⚠ Moderate length (12+ characters)');
                } else {
                    score += 5;
                    feedback.push('✗ Too short (less than 12 characters)');
                }

                // Character variety
                if (/[A-Z]/.test(password)) {
                    score += 20;
                    feedback.push('✓ Contains uppercase letters');
                } else {
                    feedback.push('✗ Missing uppercase letters');
                }

                if (/[a-z]/.test(password)) {
                    score += 20;
                    feedback.push('✓ Contains lowercase letters');
                } else {
                    feedback.push('✗ Missing lowercase letters');
                }

                if (/[0-9]/.test(password)) {
                    score += 15;
                    feedback.push('✓ Contains numbers');
                } else {
                    feedback.push('✗ Missing numbers');
                }

                if (/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)) {
                    score += 20;
                    feedback.push('✓ Contains symbols');
                } else {
                    feedback.push('✗ Missing symbols');
                }

                // Bonus points for extra complexity
                const uniqueChars = new Set(password).size;
                const complexityRatio = uniqueChars / password.length;
                if (complexityRatio > 0.7) {
                    score += 10;
                    feedback.push('✓ High character diversity');
                }

                return { score: Math.min(score, 100), feedback };
            };

            const updatePasswordStrength = () => {
                const passwordInput = document.getElementById('generator-output');
                const strengthBar = document.getElementById('strength-bar');
                const strengthText = document.getElementById('strength-text');
                const strengthDetails = document.getElementById('strength-details');

                if (!passwordInput || !strengthBar || !strengthText || !strengthDetails) return;

                const password = passwordInput.value;
                const analysis = analyzePasswordStrength(password);

                // Update strength bar
                strengthBar.style.width = `${analysis.score}%`;

                // Update colors and text based on score (enhanced with "Best" level)
                let strengthLabel = 'Weak';
                let colorClass = 'bg-red-500';

                if (analysis.score >= 90) {
                    strengthLabel = 'Best';
                    colorClass = 'bg-[var(--primary-500)]';
                } else if (analysis.score >= 75) {
                    strengthLabel = 'Strong';
                    colorClass = 'bg-green-500';
                } else if (analysis.score >= 55) {
                    strengthLabel = 'Good';
                    colorClass = 'bg-yellow-500';
                } else if (analysis.score >= 35) {
                    strengthLabel = 'Fair';
                    colorClass = 'bg-orange-500';
                }

                strengthBar.className = `h-2 rounded-full transition-all duration-300 ${colorClass}`;
                strengthText.textContent = strengthLabel;
                strengthDetails.innerHTML = `<div class="space-y-1">${analysis.feedback.map(f => `<div>${f}</div>`).join('')}</div>`;
            };

            // Password history management
            const savePasswordToHistory = (password) => {
                if (!password) return;

                let history = JSON.parse(localStorage.getItem('passwordHistory') || '[]');

                // Don't add duplicates
                if (history.includes(password)) return;

                // Add to beginning and limit to 10 entries
                history.unshift(password);
                history = history.slice(0, 10);

                localStorage.setItem('passwordHistory', JSON.stringify(history));
                loadPasswordHistory();
            };

            const loadPasswordHistory = () => {
                const historyContainer = document.getElementById('password-history');
                if (!historyContainer) return;

                const history = JSON.parse(localStorage.getItem('passwordHistory') || '[]');

                if (history.length === 0) {
                    historyContainer.innerHTML = '<div class="text-xs text-gray-500 dark:text-gray-400 italic">No recent passwords</div>';
                    return;
                }

                historyContainer.innerHTML = history.map((password, index) => `
                    <div class="flex items-center gap-2 p-2 bg-gray-100 dark:bg-gray-800 rounded text-xs">
                        <span class="font-mono truncate min-w-0 flex-1">${password.substring(0, 16)}${password.length > 16 ? '...' : ''}</span>
                        <button data-password="${index}" class="copy-history-password text-gray-500 hover:text-primary-600 dark:text-gray-400 dark:hover:text-primary-400 flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                        </button>
                    </div>
                `).join('');

                // Add event listeners for copy buttons
                historyContainer.querySelectorAll('.copy-history-password').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const passwordIndex = parseInt(e.currentTarget.getAttribute('data-password'));
                        const passwordToCopy = history[passwordIndex];
                        if (passwordToCopy) {
                            copyToClipboardWithTimeout(passwordToCopy);
                        }
                    });
                });
            };

            const clearPasswordHistory = () => {
                localStorage.removeItem('passwordHistory');
                loadPasswordHistory();
            };

            // Alternative password generators
            const generatePassphrase = () => {
                const words = ['apple', 'banana', 'cherry', 'dragon', 'elephant', 'forest', 'guitar', 'harmony', 'island', 'jungle', 'keyboard', 'lighthouse', 'mountain', 'network', 'ocean', 'puzzle', 'quantum', 'rainbow', 'sunset', 'thunder', 'universe', 'volcano', 'whisper', 'galaxy', 'meadow', 'crystal', 'phoenix', 'wizard', 'castle', 'bridge'];
                const selectedWords = [];

                for (let i = 0; i < 4; i++) {
                    const randomIndex = Math.floor(Math.random() * words.length);
                    selectedWords.push(words[randomIndex]);
                }

                const passphrase = selectedWords.join('-') + Math.floor(Math.random() * 100);
                document.getElementById('generator-output').value = passphrase;
                savePasswordToHistory(passphrase);
                updatePasswordStrength();
            };

            const generatePIN = () => {
                const pin = Math.floor(Math.random() * 900000) + 100000; // 6-digit PIN
                document.getElementById('generator-output').value = pin.toString();
                savePasswordToHistory(pin.toString());
                updatePasswordStrength();
            };

            // Function to restore event listeners after HTML structure restoration
            const setupEventListenersAfterRestore = () => {
                // Re-attach Add New Item button listener
                const addNewItemBtn = document.getElementById('add-new-item-btn');
                if (addNewItemBtn) {
                    addNewItemBtn.addEventListener('click', () => {
                        state.selectedItemId = 'new';
                        renderDetailsPane();
                    });
                }

                // Re-attach Search bar listener  
                const searchBar = document.getElementById('search-bar');
                if (searchBar) {
                    searchBar.addEventListener('input', (e) => {
                        state.searchTerm = e.target.value;
                        renderItemList();
                    });
                }

                // Re-attach Item list click listener
                const itemList = document.getElementById('item-list');
                if (itemList) {
                    itemList.addEventListener('click', (e) => {
                        const card = e.target.closest('.item-card');
                        if (card) {
                            state.selectedItemId = card.dataset.id;
                            renderItemList(); // re-render list for active state
                            renderDetailsPane();
                        }
                    });
                }
            };

            // Theme Management
            const themeButtons = {
                light: document.getElementById('theme-light'),
                dark: document.getElementById('theme-dark'),
                auto: document.getElementById('theme-auto'),
            };

            const updateActiveButton = (theme) => {
                Object.keys(themeButtons).forEach((key) => {
                    if (themeButtons[key]) {
                        themeButtons[key].classList.toggle('active', key === theme);
                    }
                });
            };

            const applyTheme = (theme) => {
                const root = document.documentElement;

                // Remove any existing theme classes first
                root.classList.remove('dark');

                if (theme === 'dark') {
                    root.classList.add('dark');
                } else if (theme === 'light') {
                    // light mode is default, no class needed
                } else if (theme === 'auto') {
                    // Auto = follow system
                    if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                        root.classList.add('dark');
                    }
                }

                localStorage.setItem('theme', theme);
                updateActiveButton(theme);
            };

            // Button click handlers
            Object.keys(themeButtons).forEach((key) => {
                if (themeButtons[key]) {
                    themeButtons[key].addEventListener('click', () => applyTheme(key));
                }
            });

            // On load → apply saved or auto theme
            const savedTheme = localStorage.getItem('theme') || 'auto';
            applyTheme(savedTheme);

            // Also update if system theme changes while "auto" is active
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                if (localStorage.getItem('theme') === 'auto') {
                    applyTheme('auto');
                }
            });


            // --- INITIALIZATION ---
            const init = () => {
                render();
                updateAutoLockFooter();

                // Add global activity listeners for auto logout
                const activityEvents = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];

                activityEvents.forEach(event => {
                    document.addEventListener(event, () => {
                        if (!state.isLocked) {
                            resetAutoLogoutTimer();
                        }
                    }, { passive: true });
                });
            };

            init();
        });
    </script>
</body>

</html>